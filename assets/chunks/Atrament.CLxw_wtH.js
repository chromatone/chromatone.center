import{_ as D,r as L,o as T,S as B,M as I,q as O,f as $,Z as F,s as M,$ as H,v as K,u as m}from"./framework.CxSiiyCs.js";import{F as Y,E as q,R as N,P,b1 as X,b4 as z}from"./theme.DLCqlVTm.js";class b{constructor(t,e){this.x=t,this.y=e}set(t,e){this.x=t,this.y=e}}class R extends b{constructor(){super(0,0),this.down=!1,this.previous=new b(0,0)}}class V{constructor(){this.eventListeners=new Map}addEventListener(t,e){const s=this.eventListeners.get(t)||new Set;s.add(e),this.eventListeners.set(t,s)}removeEventListener(t,e){const s=this.eventListeners.get(t);s&&s.delete(e)}dispatchEvent(t,e){const s=this.eventListeners.get(t);s&&[...s].forEach(i=>i(e))}}const _=(h,t,e,s)=>{const i=(e-h)**2,o=(s-t)**2;return Math.sqrt(i+o)},E=(h,t)=>e=>{!e.isPrimary||!t.secondaryMouseButton&&e.button>0||t.ignoreModifiers&&(e.altKey||e.ctrlKey||e.metaKey||e.button===1)||(e.cancelable&&e.preventDefault(),h(e))},C=(h,t,e,s,i)=>(h-t)*(i-s)/(e-t)+s,l="draw",p="erase",g="fill",S="disabled",A=[l,p],G=["weight","smoothing","adaptiveStroke","mode","secondaryMouseButton","ignoreModifiers","pressureLow","pressureHigh","pressureSmoothing"];class w extends V{adaptiveStroke=!0;canvas;recordStrokes=!1;smoothing=.85;thickness=2;secondaryMouseButton=!1;ignoreModifiers=!1;pressureLow=0;pressureHigh=2;pressureSmoothing=.3;#e;#a=!1;#r=!1;#c=!1;#d=[];#n=null;#i=l;#t=new R;#h=.5;#u;#l=[];#o=2;#s=2;constructor(t,e={}){if(typeof window>"u")throw new Error("atrament: looks like we're not running in a browser");super(),this.canvas=w.#w(t,e),this.#e=w.#k(this.canvas,e),this.#S({FillWorker:e.fill}),this.#u=(({canvas:s,move:i,down:o,up:r},a)=>{const d=E(i,a),c=E(o,a),n=E(r,a);return s.addEventListener("pointermove",d),s.addEventListener("pointerdown",c),document.addEventListener("pointerup",n),document.addEventListener("pointerout",n),()=>{s.removeEventListener("pointermove",d),s.removeEventListener("pointerdown",c),document.removeEventListener("pointerup",n),document.removeEventListener("pointerout",n)}})({canvas:this.canvas,move:this.#v.bind(this),down:this.#y.bind(this),up:this.#E.bind(this)},this),G.forEach(s=>{e[s]!==void 0&&(this[s]=e[s])}),this.canvas.addEventListener("contextmenu",s=>{this.secondaryMouseButton&&this.mode!==S?s.preventDefault():this.#a=!0})}beginStroke(t,e){this.#e.moveTo(t,e),this.#o=this.#s,this.recordStrokes&&(this.strokeTimestamp=performance.now()),this.dispatchEvent("strokestart",{x:t,y:e})}endStroke(t,e){this.dispatchEvent("strokeend",{x:t,y:e}),this.recordStrokes&&this.dispatchEvent("strokerecorded",{stroke:this.currentStroke}),this.#l=[],delete this.strokeTimestamp}draw(t,e,s,i,o=.5){const r=s||t,a=i||e,d=this.getSmoothingFactor(_(t,e,r,a)),c=t-(t-r)*d,n=e-(e-a)*d,u=o-(o-this.#h)*this.pressureSmoothing,k=_(c,n,r,a);if(this.adaptiveStroke&&o===.5){const f=(k-2)/98*(this.#m-this.#s)+this.#s;this.#o>f?this.#o-=.25:this.#o<f&&(this.#o+=.25)}else this.#o=this.#g(u);this.#e.lineWidth=this.#o/this.canvas.offsetWidth*this.canvas.width;const v=this.#p(r,a),y=this.#p(c,n);return this.#e.beginPath(),this.#e.moveTo(...v),this.#e.quadraticCurveTo(...v,...y),this.#e.closePath(),this.#e.stroke(),this.recordStrokes&&(this.#l.push({point:new b(t,e),time:performance.now()-this.strokeTimestamp,pressure:o}),this.dispatchEvent("segmentdrawn",{stroke:this.currentStroke})),this.#r||this.#i!==l||(this.#r=!0,this.dispatchEvent("dirty")),{x:c,y:n}}clear(){this.#r=!1,this.dispatchEvent("clean");const t=this.mode===p;t&&(this.mode=l),this.#e.save(),this.#e.setTransform(1,0,0,1,0,0),this.#e.clearRect(0,0,this.canvas.width,this.canvas.height),this.#e.restore(),t&&(this.mode=p)}destroy(){this.clear(),this.#u?.()}get color(){return this.#e.strokeStyle}set color(t){if(typeof t!="string")throw new Error("atrament: wrong argument type setting color");this.#e.strokeStyle=t}get weight(){return this.#s}set weight(t){if(typeof t!="number")throw new Error("atrament: wrong argument type setting weight");this.#o=t,this.#s=t}get#m(){return this.#s+30}getSmoothingFactor(t){return Math.min(.87,this.smoothing+(t-60)/3e3)}get mode(){return this.#i}set mode(t){switch(t){case p:this.#i=p,this.#e.globalCompositeOperation="destination-out";break;case g:this.#i=g,this.#e.globalCompositeOperation="source-over";break;case S:this.#i=S;break;case l:this.#i=l,this.#e.globalCompositeOperation="source-over";break;default:throw new Error("atrament: mode is not one of the allowed modes.")}}get currentStroke(){return{segments:this.#l.slice(),mode:this.mode,weight:this.weight,smoothing:this.smoothing,color:this.color,adaptiveStroke:this.adaptiveStroke}}get dirty(){return this.#r}#p(t,e){return[t/this.canvas.offsetWidth*this.canvas.width,e/this.canvas.offsetHeight*this.canvas.height]}#g(t){return t===.5?this.#s:t<.5?this.#s*C(t,0,.5,this.pressureLow,1):this.#s*C(t,.5,1,1,this.pressureHigh)}static#w(t,e){let s;if(t instanceof window.Node&&t.tagName==="CANVAS")s=t;else{if(typeof t!="string")throw new Error(`atrament: can't look for canvas based on '${t}'`);s=document.querySelector(t)}if(!s)throw new Error("atrament: canvas not found");return s.width=e.width||s.width,s.height=e.height||s.height,s.style.touchAction="none",s}static#k(t,e){const s=t.getContext("2d");return s.globalCompositeOperation="source-over",s.globalAlpha=1,s.strokeStyle=e.color||"rgba(0,0,0,1)",s.lineCap="round",s.lineJoin="round",s}#v(t){(t.getCoalescedEvents?.()||[t]).forEach(e=>{const s=e.offsetX,i=e.offsetY;if(this.#t.down&&A.includes(this.#i)){this.#a&&(this.#t.previous.set(s,i),this.#a=!1);const{x:o,y:r}=this.draw(s,i,this.#t.previous.x,this.#t.previous.y,e.pressure);this.#t.set(s,i),this.#t.previous.set(o,r),this.#h=e.pressure}else this.#t.set(s,i),this.#t.previous.set(s,i)})}#y(t){this.dispatchEvent("pointerdown",t),this.mode!==g?(this.#t.down=!0,this.#v(t),this.#h=t.pressure,this.beginStroke(this.#t.previous.x,this.#t.previous.y)):this.#b()}#E(t){this.dispatchEvent("pointerup",t),this.#i!==g&&this.#t.down&&(this.#t.down=!1,this.#t.x===t.offsetX&&this.#t.y===t.offsetY&&A.includes(this.mode)&&this.draw(this.#t.x,this.#t.y,this.#t.previous.x,this.#t.previous.y,this.#h),this.#t.previous.set(0,0),this.endStroke(this.#t.x,this.#t.y))}#S({FillWorker:t}){t&&(this.#n=new t,this.#n.addEventListener("message",({data:e})=>{if(e.type==="fill-result"){this.#c=!1,this.dispatchEvent("fillend",{});const s=new ImageData(e.result,this.canvas.width,this.canvas.height);this.#e.putImageData(s,0,0),this.#d.length>0&&this.#f(this.#d.shift())}}))}#b(){if(!this.#n)throw new Error("atrament: fill mode only works if the fillWorker option is passed to the Atrament constructor");const{x:t,y:e}=this.#t;this.dispatchEvent("fillstart",{x:t,y:e});const s=Array.from(this.#e.getImageData(t,e,1,1).data),i={color:this.color,globalAlpha:this.#e.globalAlpha,width:this.canvas.width,height:this.canvas.height,startColor:s,startX:t,startY:e};this.#c?this.#d.push(i):(this.#c=!0,this.#f(i))}#f(t){const e=this.#e.getImageData(0,0,this.canvas.width,this.canvas.height).data;this.#n?.postMessage({image:e,...t},[e.buffer])}}const J={class:"p-0 relative min-h-90vh"},Z={__name:"Atrament",setup(h){const t=L(),e=L(!1);let s;T(()=>{s=new w(t.value,{width:t.value.offsetWidth,height:t.value.offsetHeight,color:"currentColor"}),B(()=>{s.color=o.value,s.weight=i.value}),s.addEventListener("strokestart",()=>e.value=!0),s.addEventListener("strokeend",()=>e.value=!1)});const i=Y(30,.1,3e3),o=I(()=>q(r?.note?.pitch,r?.note?._octave)),{midi:r}=N();P({onWheel:d},{...{wheel:{preventWindowScrollY:!0},eventOptions:{capture:!1,passive:!1}},domTarget:t});function d(u){const{delta:[k,v],wheeling:y,shiftKey:f,event:x}=u;if(!y)return;x&&x.preventDefault();let W=v/(f?12:8);i.value+=W}X("Enter",u=>{s.clear()});const{elementX:c,elementY:n}=z(t);return(u,k)=>($(),O("div",J,[F(M("div",{class:"z-1000 pointer-events-none rounded-full absolute top-10 left-10 w-30",style:K({backgroundColor:o.value,transform:"translate(-50%, -50%)",width:`${m(i)}px`,height:`${m(i)}px`,top:`${m(n)}px`,left:`${m(c)}px`})},"Â ",4),[[H,!e.value]]),M("canvas",{ref_key:"canvas",ref:t,width:"800",height:"800"},null,512)]))}},tt=D(Z,[["__scopeId","data-v-a82adee9"]]);export{tt as default};
