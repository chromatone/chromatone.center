import{$ as z,u as D,aO as F,b0 as e,I as G,S as T,J as U,aX as H}from"./theme.DRfkbxnY.js";import{r as w,b as B,d as b,w as V,u as I,K as d,C as v,D as x,F as P,G as C,H as E,M as J,R as K,a0 as L}from"./framework.C3LH_Uf3.js";const O={"osc:volume":{value:.2,min:0,max:1,step:.01},"osc:shape":{value:.2,min:0,max:1,step:.01},"fx:pingPong":{value:.1,min:0,max:1,step:.01},"fx:feedback":{value:.1,min:0,max:1,step:.01},"fx:shift":{value:.4,min:0,max:1,step:.01},"fx:bpm":{value:120,min:10,max:500,step:1,hidden:!0}};function X(m=12){const p=w(!1),{controls:f,cv:l,groups:g}=A(O,"ref"),i={};for(let s=0;s<m;s++)i[`v${s}:gate`]={value:0,min:0,max:1,step:1},i[`v${s}:midi`]={value:0,min:0,max:127,step:1},i[`v${s}:vel`]={value:0,min:0,max:127,step:1};const{controls:c,cv:t,groups:o}=A(i,"ref"),a=B(Array(m).fill(!0).map((s,u)=>({key:`v${u}`,gate:0,midi:69,vel:0})));b(a,s=>{for(let u of s)c[`${u.key}:gate`]=u.gate,c[`${u.key}:midi`]=u.midi,c[`${u.key}:vel`]=u.vel});const n=w(0),r=w(0);function y(s=60,u=0){if(u){do if(n.value++,n.value>=a.length&&(n.value=0,r.value++),r.value>3)break;while(a[n.value].gate==1);r.value=0,a[n.value].gate=1,a[n.value].midi=s,a[n.value].vel=u}else a.forEach(k=>{k.midi==s&&(k.gate=0,k.vel=0)})}function $(s){a.forEach(u=>u.gate=0)}const _=z();V(()=>{f["fx:bpm"]=_.bpm});const{midi:M}=D();b(()=>M.note,s=>y(s.number,s.velocity));const{audio:h,render:N}=F();V(()=>{h.initiated&&(h.layers.saw={volume:.7,signal:q(S())})});function S(){return e.mul(l["osc:volume"],e.mul(e.sqrt(e.const({key:"voice-count",value:1/a.length})),e.add(...a.map(s=>e.mul(e.adsr(1,2,.5,2,t[`${s.key}:gate`]),e.div(t[`${s.key}:vel`],127),e.add(e.mul(e.sub(1,l["osc:shape"]),e.blepsquare(R(t[`${s.key}:midi`]))),e.mul(l["osc:shape"],e.blepsaw(R(t[`${s.key}:midi`])))))))))}function q(s){return Array(2).fill(null).map((u,k)=>e.add(s,e.mul(l["fx:pingPong"],e.delay({size:44100},e.ms2samps(e.mul(e.div(6e4,l["fx:bpm"]),e.add(1,e.mul(k==0?-.5:.5,l["fx:shift"])))),l["fx:feedback"],s))))}return{controls:f,cv:l,groups:g,audio:h,render:N,started:p,voices:a,cycleNote:y,stopAll:$}}function R(m){return e.mul(440,e.pow(2,e.smooth(e.tau2pole(.001),e.div(e.sub(m,69),12))))}function A(m,p="ref"){const{audio:f}=F(),l=B({}),g={},i={},c={};for(let t in m){let o=m[t];if(l[t]=G(o!=null&&o.nostore?o.value:I(`${p}:${t}`,o.value),o.min,o.max),!(o!=null&&o.hidden)){const a=t.split(":"),n=a.pop(),r=a.pop();c[r]=c[r]||{},c[r][n]=o}}return b(()=>f.initiated,()=>{if(f.initiated)for(let t in m){let[o,a]=f.core.createRef("const",{value:l[t]},[]);g[t]=o,i[t]=a}},{immediate:!0}),b(l,t=>{for(let o in t)i[o]&&i[o]({value:t[o]})}),{controls:l,cv:g,setters:i,groups:c}}const j={key:1,class:"flex flex-col gap-4"},Q={class:"flex gap-1"},Z={__name:"ElemRef",setup(m){const{controls:p,groups:f,started:l,render:g,voices:i}=X();return(c,t)=>{const o=U,a=H;return d(l)?(v(),x("div",j,[P("button",{class:"text-button",onMousedown:t[1]||(t[1]=n=>d(p)["osc:playing"]=1),onMouseup:t[2]||(t[2]=n=>d(p)["osc:playing"]=0)},"Play",32),P("div",Q,[(v(!0),x(C,null,E(d(i),n=>(v(),x("div",{class:"p-1 flex-1 rounded-xl",key:n,style:J({backgroundColor:d(T)(n.midi-9,3,n.gate?1:0)})},null,4))),128))]),(v(!0),x(C,null,E(d(f),(n,r)=>(v(),x("div",{class:"flex flex-wrap gap-2 is-group p-2",key:n},[(v(!0),x(C,null,E(n,(y,$)=>(v(),K(o,{modelValue:d(p)[`${r}:${$}`],"onUpdate:modelValue":_=>d(p)[`${r}:${$}`]=_,min:y.min,max:y.max,step:y.step,param:$},null,8,["modelValue","onUpdate:modelValue","min","max","step","param"]))),256))]))),128)),L(a)])):(v(),x("button",{key:0,class:"text-button",onClick:t[0]||(t[0]=n=>{d(g)(),l.value=!0})},"RENDER "))}}};export{Z as default};
