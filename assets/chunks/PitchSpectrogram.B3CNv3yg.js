import{an as G,r as S,b as H,c as j,u as y,d as k,o as F,a6 as K,h as R,P as W,x as d,y as p,A as s,C as J,L as Q,I as $,E as h,G as E,R as V,V as P,_ as X}from"./framework.DZXgQweA.js";import{bd as Y,H as b,be as Z,bf as ee,aq as te}from"./theme.ChOOrrTG.js";import{_ as oe}from"./ControlStart.DOYYHAy_.js";const se={class:"flex flex-col justify-center"},ae={class:"fullscreen-container text-white",id:"screen"},ne=["width","height"],le={class:"text-xl"},ie={class:"op-50"},re={key:0,class:"i-la-play"},de={key:1,class:"i-la-pause"},ce={key:0,class:"i-la-arrow-left"},ue={key:1,class:"i-la-arrow-down"},pe={class:"absolute w-full bottom-2 flex items-end gap-2 px-2 flex-wrap"},me={key:0,class:"is-group flex flex-wrap gap-2 flex-0 p-2 op-20 hover-op-80 transition ml-16"},ve={class:"scale-75 max-h-60 overflow-clip relative text-white op-20 hover-op-80 transition"},xe={__name:"PitchSpectrogram",setup(he){let c,n,i,M,u;const{mic:A,input:q}=Y(),{width:I,height:D}=G(),C=S(),f=S(),r=S(!1),t=H({initiated:!1,width:I,height:D,speed:j(()=>Math.floor(t.speedCount/100)),speedCount:b(100,100,500),vertical:y("spectrogram-vertical",!1),pow:y("spectrogram-power",1),offset:y("spectrogram-offset",0)});k([I,D],([o,e])=>{!c&&!i||(t.width=c.width=i.width=o,t.height=c.height=i.height=e,_())}),F(()=>{Z(),c=C.value,n=c.getContext("2d"),i=document.createElement("canvas"),M=i.getContext("2d"),i.width=t.width,i.height=t.height,_();const o=C.value.captureStream();f.value.srcObject=o,f.value.play().then(()=>{var e,a;return(a=(e=f.value)==null?void 0:e.requestPictureInPicture)==null?void 0:a.call(e)}).catch(e=>console.error(e))});const z=o=>12*(Math.log(Number(o)/440)/Math.log(2)),N=(o,e)=>`hsl(${z(o)*30}, ${e*100}%, ${e*75}%)`,g=b(10,3,30),w=b(.5,0,1),O=o=>1/(1+Math.exp(-g.value*(o-w.value))),T=o=>{if(r.value)return;M.drawImage(c,0,0,t.width,t.height);let e=o.getBars();for(let a=0;a<e.length;a++){const v=(e[a].freqLo+e[a].freqHi)/2;n.fillStyle=N(v,O(e[a].value[0])),t.vertical?n.fillRect(a*(t.width/e.length),0,t.width/e.length,t.speed):n.fillRect(t.width-t.speed,t.height-(a+1)*(t.height/e.length),t.speed,t.height/e.length)}t.vertical?n.translate(0,t.speed):n.translate(-t.speed,0),n.drawImage(i,0,0,t.width,t.height),n.setTransform(1,0,0,1,0,0)},x=K([4096,8192,16384,32768],{initialValue:8192});k(x.state,o=>u&&(u.fftSize=o));const m=b(y("monochord-smoothing",.5),0,.9);k(m,o=>u&&(u.smoothing=o));function B(){navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,autoGainControl:!0,noiseSuppression:!1},video:!1}).then(async()=>{const{AudioMotionAnalyzer:o}=await X(async()=>{const{AudioMotionAnalyzer:e}=await import("./audioMotion-analyzer.7XoESQPH.js");return{AudioMotionAnalyzer:e}},[]);u=new o(null,{mode:1,connectSpeakers:!1,volume:0,fftSize:x.state.value,smoothing:m.value,useCanvas:!1,onCanvasDraw:T,source:ee.meter}),t.initiated=!0,A.open=!0,u.connectInput(q)}).catch(o=>{console.log("mic denied",o)})}function _(){n.fillStyle="#000",n.fillRect(0,0,t.width,t.height)}function U(o){o.tap&&(r.value=!r.value),t.speedCount-=o.delta[0]/2}return R(" ",o=>{r.value=!r.value,o.preventDefault()}),R("Enter",o=>{_(),o.preventDefault()}),(o,e)=>{const a=oe,v=te,L=W("drag");return d(),p("div",se,[s("div",ae,[J(s("canvas",{class:"cursor-pointer max-w-full",id:"spectrogram",ref_key:"canvasElement",ref:C,width:t.width,height:t.height},null,8,ne),[[L,U]]),t.initiated?$("",!0):(d(),Q(a,{key:0,class:"absolute",onClick:e[0]||(e[0]=l=>B())})),s("div",{class:"absolute top-4 left-4 select-none cursor-pointer flex items-baseline gap-2",onPointerdown:e[1]||(e[1]=l=>h(x).next())},[s("div",le,"x"+E(t.speed),1),s("div",ie,E(h(x).state)+" samples/frame",1)],32),s("button",{class:"absolute bottom-4 left-4 text-xl select-none cursor-pointer",onPointerdown:e[2]||(e[2]=l=>r.value=!r.value)},[r.value?(d(),p("div",re)):(d(),p("div",de))],32),s("button",{class:"absolute bottom-4 right-4 text-xl select-none cursor-pointer",onPointerdown:e[3]||(e[3]=l=>t.vertical=!t.vertical)},[t.vertical?(d(),p("div",ue)):(d(),p("div",ce))],32),s("button",{class:"absolute top-4 right-4 text-xl select-none cursor-pointer",onPointerdown:e[4]||(e[4]=l=>_())},e[8]||(e[8]=[s("div",{class:"i-la-trash-alt"},null,-1)]),32)]),s("div",pe,[t.initiated?(d(),p("div",me,[V(v,{modelValue:h(g),"onUpdate:modelValue":e[5]||(e[5]=l=>P(g)?g.value=l:null),min:3,max:30,step:1e-4,fixed:2,param:"CONTRAST"},null,8,["modelValue"]),V(v,{modelValue:h(w),"onUpdate:modelValue":e[6]||(e[6]=l=>P(w)?w.value=l:null),min:0,max:1,step:1e-4,param:"MIDPOINT",fixed:2},null,8,["modelValue"]),V(v,{modelValue:h(m),"onUpdate:modelValue":e[7]||(e[7]=l=>P(m)?m.value=l:null),min:0,max:1,step:1e-4,param:"SMOOTH",fixed:2},null,8,["modelValue"])])):$("",!0),e[10]||(e[10]=s("div",{class:"flex-1"},null,-1)),s("div",ve,[e[9]||(e[9]=s("div",{class:"absolute p-2 opacity-70 touch-none select-none text-md"},"Right click here to enter Picture-In-Picture mode",-1)),s("video",{class:"max-h-50",ref_key:"video",ref:f},null,512)])])])}}};export{xe as default};
