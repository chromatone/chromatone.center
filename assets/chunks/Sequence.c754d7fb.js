import{o as p,a3 as d,p as f,a4 as c,a5 as a,a6 as b,a7 as _,a8 as g,a9 as k,c as S,aa as m}from"./index.15d43a61.js";import{T as h}from"./Loop.ec9616fc.js";class l extends h{constructor(){super(p(l.getDefaults(),arguments,["callback","events"])),this.name="Part",this._state=new d("stopped"),this._events=new Set;const t=p(l.getDefaults(),arguments,["callback","events"]);this._state.increasing=!0,t.events.forEach(s=>{f(s)?this.add(s[0],s[1]):this.add(s)})}static getDefaults(){return Object.assign(h.getDefaults(),{events:[]})}start(t,s){const e=this.toTicks(t);if(this._state.getValueAtTime(e)!=="started"){s=c(s,this._loop?this._loopStart:0),this._loop?s=c(s,this._loopStart):s=c(s,0);const i=this.toTicks(s);this._state.add({id:-1,offset:i,state:"started",time:e}),this._forEach(o=>{this._startNote(o,e,i)})}return this}_startNote(t,s,e){s-=e,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<e&&(s+=this._getLoopDuration()),t.start(new a(this.context,s))):t.startOffset<this._loopStart&&t.startOffset>=e&&(t.loop=!1,t.start(new a(this.context,s))):t.startOffset>=e&&t.start(new a(this.context,s))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(s=>{s.startOffset+=this._startOffset})}stop(t){const s=this.toTicks(t);return this._state.cancel(s),this._state.setStateAtTime("stopped",s),this._forEach(e=>{e.stop(t)}),this}at(t,s){const e=new b(this.context,t).toTicks(),i=new a(this.context,1).toSeconds(),o=this._events.values();let r=o.next();for(;!r.done;){const n=r.value;if(Math.abs(e-n.startOffset)<i)return _(s)&&(n.value=s),n;r=o.next()}return _(s)?(this.add(t,s),this.at(t)):null}add(t,s){t instanceof Object&&Reflect.has(t,"time")&&(s=t,t=s.time);const e=this.toTicks(t);let i;return s instanceof h?(i=s,i.callback=this._tick.bind(this)):i=new h({callback:this._tick.bind(this),context:this.context,value:s}),i.startOffset=e,i.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(i),this._restartEvent(i),this}_restartEvent(t){this._state.forEach(s=>{s.state==="started"?this._startNote(t,s.time,s.offset):t.stop(new a(this.context,s.time))})}remove(t,s){return g(t)&&t.hasOwnProperty("time")&&(s=t,t=s.time),t=this.toTicks(t),this._events.forEach(e=>{e.startOffset===t&&(k(s)||_(s)&&e.value===s)&&(this._events.delete(e),e.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(s=>s.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(s=>{s instanceof l?s._forEach(t):t(s)}),this}_setAll(t,s){this._forEach(e=>{e[t]=s})}_tick(t,s){this.mute||this.callback(t,s)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(s=>{s.loopStart=this.loopStart,s.loopEnd=this.loopEnd,s.loop=t,this._testLoopBoundries(s)})}get loopEnd(){return new a(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopEnd=t,this._testLoopBoundries(s)})}get loopStart(){return new a(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(s=>{s.loopStart=this.loopStart,this._testLoopBoundries(s)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}class u extends h{constructor(){super(p(u.getDefaults(),arguments,["callback","events","subdivision"])),this.name="Sequence",this._part=new l({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[];const t=p(u.getDefaults(),arguments,["callback","events","subdivision"]);this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign(S(h.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,s){s!==null&&!this.mute&&this.callback(t,s)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,s){return this._part.start(t,s&&this._indexTime(s)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new a(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(s,e)=>s[e],set:(s,e,i)=>(m(e)&&isFinite(parseInt(e,10))&&f(i)?s[e]=this._createSequence(i):s[e]=i,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,s,e){t.forEach((i,o)=>{const r=o*s+e;if(f(i))this._rescheduleSequence(i,s/i.length,r);else{const n=new a(this.context,r,"i").toSeconds();this._part.add(n,i)}})}_indexTime(t){return new a(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,t===0?this._part.loopEnd=this._indexTime(this._eventsArray.length):this._part.loopEnd=this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}export{l as P,u as S};
