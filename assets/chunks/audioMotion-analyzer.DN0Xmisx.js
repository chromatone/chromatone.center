/**!
 * audioMotion-analyzer
 * High-resolution real-time graphic audio spectrum analyzer JS module
 *
 * @version 4.5.0
 * @author  Henrique Avila Vianna <hvianna@gmail.com> <https://henriquevianna.com>
 * @license AGPL-3.0-or-later
 */const Pt="4.5.0",ht=Math.PI,Fe=2*ht,at=ht/2,gt=8.17579892,pt="dual-combined",Ve="dual-horizontal",Ae="single",Re="dual-vertical",mt="bar-index",Lt="bar-level",je="gradient",Rt=60,wt="click",Xt="fullscreenchange",kt="resize",Wt="#111",Ft="",At="A",yt="B",Et="C",St="D",bt="468",Ye="sans-serif",Ut="#0f0",Vt="#7f7f7f22",De=10,Ct="create",Tt="fschange",Yt="lores",$t=kt,nt="user",jt="#000c",vt="#fff",Qt="#4f4",xt="#888",Kt="#555",rt="bark",qe="linear",Ne="log",lt="mel",Bt=["#a35","#c66","#e94","#ed0","#9d5","#4d8","#2cb","#0bc","#09c","#36b"],Dt=[["classic",{colorStops:["red",{color:"yellow",level:.85,pos:.6},{color:"lime",level:.475}]}],["prism",{colorStops:Bt}],["rainbow",{dir:"h",colorStops:["#817",...Bt,"#639"]}],["orangered",{bgColor:"#3e2f29",colorStops:["OrangeRed"]}],["steelblue",{bgColor:"#222c35",colorStops:["SteelBlue"]}]],Pe={alphaBars:!1,ansiBands:!1,barSpace:.1,bgAlpha:.7,channelLayout:Ae,colorMode:je,fadePeaks:!1,fftSize:8192,fillAlpha:1,frequencyScale:Ne,gradient:Dt[0][0],gravity:3.8,height:void 0,ledBars:!1,linearAmplitude:!1,linearBoost:1,lineWidth:0,loRes:!1,lumiBars:!1,maxDecibels:-25,maxFPS:0,maxFreq:22e3,minDecibels:-85,minFreq:20,mirror:0,mode:0,noteLabels:!1,outlineBars:!1,overlay:!1,peakFadeTime:750,peakHoldTime:500,peakLine:!1,radial:!1,radialInvert:!1,radius:.3,reflexAlpha:.15,reflexBright:1,reflexFit:!0,reflexRatio:0,roundBars:!1,showBgColor:!0,showFPS:!1,showPeaks:!0,showScaleX:!0,showScaleY:!1,smoothing:.5,spinSpeed:0,splitGradient:!1,start:!0,trueLeds:!1,useCanvas:!0,volume:1,weightingFilter:Ft,width:void 0},Jt=["ERR_AUDIO_CONTEXT_FAIL","Could not create audio context. Web Audio API not supported?"],Zt=["ERR_INVALID_AUDIO_CONTEXT","Provided audio context is not valid"],ei=["ERR_UNKNOWN_GRADIENT","Unknown gradient"],ot=["ERR_FREQUENCY_TOO_LOW","Frequency values must be >= 1"],ti=["ERR_INVALID_MODE","Invalid mode"],ii=["ERR_REFLEX_OUT_OF_RANGE","Reflex ratio must be >= 0 and < 1"],si=["ERR_INVALID_AUDIO_SOURCE","Audio source must be an instance of HTMLMediaElement or AudioNode"],ai=["ERR_GRADIENT_INVALID_NAME","Gradient name must be a non-empty string"],ni=["ERR_GRADIENT_NOT_AN_OBJECT","Gradient options must be an object"],ri=["ERR_GRADIENT_MISSING_COLOR","Gradient colorStops must be a non-empty array"];class he extends Error{constructor(e,i){const[s,n]=e;super(n+(i!==void 0?`: ${i}`:"")),this.name="AudioMotionError",this.code=s}}const It=(re,e)=>console.warn(`${re} is deprecated. Use ${e} instead.`),Ot=re=>{for(const e in re)return!1;return!0},$e=(re,e,i="toLowerCase")=>e[Math.max(0,e.indexOf((""+re)[i]()))],li=(re,e,i,s,n)=>e+(s-e)*(n-re)/(i-re);Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(re){let e=this.length;for(;e-- >0;)if(re(this[e]))return e;return-1});class hi{constructor(e,i={}){this._ready=!1,this._aux={},this._canvasGradients=[],this._destroyed=!1,this._energy={val:0,peak:0,hold:0},this._flg={},this._fps=0,this._gradients={},this._last=0,this._outNodes=[],this._ownContext=!1,this._selectedGrads=[],this._sources=[],e instanceof Element||(Ot(i)&&!Ot(e)&&(i=e),e=null),this._ownCanvas=!(i.canvas instanceof HTMLCanvasElement);const s=this._ownCanvas?document.createElement("canvas"):i.canvas;s.style="max-width: 100%;",this._ctx=s.getContext("2d");for(const[g,v]of Dt)this.registerGradient(g,v);this._container=e||!this._ownCanvas&&s.parentElement||document.body,this._defaultWidth=this._container.clientWidth||640,this._defaultHeight=this._container.clientHeight||270;let n;if(!(i.source&&(n=i.source.context))){if(!(n=i.audioCtx))try{n=new(window.AudioContext||window.webkitAudioContext),this._ownContext=!0}catch{throw new he(Jt)}}if(!n.createGain)throw new he(Zt);const d=this._analyzer=[n.createAnalyser(),n.createAnalyser()],r=this._splitter=n.createChannelSplitter(2),l=this._merger=n.createChannelMerger(2);this._input=n.createGain(),this._output=n.createGain(),i.source&&this.connectInput(i.source);for(const g of[0,1])r.connect(d[g],g);l.connect(this._output),i.connectSpeakers!==!1&&this.connectOutput();for(const g of["_scaleX","_scaleR"])this[g]=document.createElement("canvas").getContext("2d");this._fsEl=i.fsElement||s;const h=()=>{this._fsTimeout||(this._fsTimeout=window.setTimeout(()=>{this._fsChanging||(this._setCanvas($t),this._fsTimeout=0)},Rt))};window.ResizeObserver&&(this._observer=new ResizeObserver(h),this._observer.observe(this._container)),this._controller=new AbortController;const E=this._controller.signal;window.addEventListener(kt,h,{signal:E}),s.addEventListener(Xt,()=>{this._fsChanging=!0,this._fsTimeout&&window.clearTimeout(this._fsTimeout),this._setCanvas(Tt),this._fsTimeout=window.setTimeout(()=>{this._fsChanging=!1,this._fsTimeout=0},Rt)},{signal:E});const u=()=>{n.state=="suspended"&&n.resume(),window.removeEventListener(wt,u)};window.addEventListener(wt,u),document.addEventListener("visibilitychange",()=>{document.visibilityState!="hidden"&&(this._frames=0,this._time=performance.now())},{signal:E}),this._setProps(i,!0),this.useCanvas&&this._ownCanvas&&this._container.appendChild(s),this._ready=!0,this._setCanvas(Ct)}get alphaBars(){return this._alphaBars}set alphaBars(e){this._alphaBars=!!e,this._calcBars()}get ansiBands(){return this._ansiBands}set ansiBands(e){this._ansiBands=!!e,this._calcBars()}get barSpace(){return this._barSpace}set barSpace(e){this._barSpace=+e||0,this._calcBars()}get channelLayout(){return this._chLayout}set channelLayout(e){this._chLayout=$e(e,[Ae,Ve,Re,pt]),this._input.disconnect(),this._input.connect(this._chLayout!=Ae?this._splitter:this._analyzer[0]),this._analyzer[0].disconnect(),this._outNodes.length&&this._analyzer[0].connect(this._chLayout!=Ae?this._merger:this._output),this._calcBars(),this._makeGrad()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=$e(e,[je,mt,Lt])}get fadePeaks(){return this._fadePeaks}set fadePeaks(e){this._fadePeaks=!!e}get fftSize(){return this._analyzer[0].fftSize}set fftSize(e){for(const s of[0,1])this._analyzer[s].fftSize=e;const i=this._analyzer[0].frequencyBinCount;this._fftData=[new Float32Array(i),new Float32Array(i)],this._calcBars()}get frequencyScale(){return this._frequencyScale}set frequencyScale(e){this._frequencyScale=$e(e,[Ne,rt,lt,qe]),this._calcBars()}get gradient(){return this._selectedGrads[0]}set gradient(e){this._setGradient(e)}get gradientLeft(){return this._selectedGrads[0]}set gradientLeft(e){this._setGradient(e,0)}get gradientRight(){return this._selectedGrads[1]}set gradientRight(e){this._setGradient(e,1)}get gravity(){return this._gravity}set gravity(e){this._gravity=e>0?+e:this._gravity||Pe.gravity}get height(){return this._height}set height(e){this._height=e,this._setCanvas(nt)}get ledBars(){return this._showLeds}set ledBars(e){this._showLeds=!!e,this._calcBars()}get linearAmplitude(){return this._linearAmplitude}set linearAmplitude(e){this._linearAmplitude=!!e}get linearBoost(){return this._linearBoost}set linearBoost(e){this._linearBoost=e>=1?+e:1}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=+e||0}get loRes(){return this._loRes}set loRes(e){this._loRes=!!e,this._setCanvas(Yt)}get lumiBars(){return this._lumiBars}set lumiBars(e){this._lumiBars=!!e,this._calcBars(),this._makeGrad()}get maxDecibels(){return this._analyzer[0].maxDecibels}set maxDecibels(e){for(const i of[0,1])this._analyzer[i].maxDecibels=e}get maxFPS(){return this._maxFPS}set maxFPS(e){this._maxFPS=e<0?0:+e||0}get maxFreq(){return this._maxFreq}set maxFreq(e){if(e<1)throw new he(ot);this._maxFreq=Math.min(e,this.audioCtx.sampleRate/2),this._calcBars()}get minDecibels(){return this._analyzer[0].minDecibels}set minDecibels(e){for(const i of[0,1])this._analyzer[i].minDecibels=e}get minFreq(){return this._minFreq}set minFreq(e){if(e<1)throw new he(ot);this._minFreq=+e,this._calcBars()}get mirror(){return this._mirror}set mirror(e){this._mirror=Math.sign(e)|0,this._calcBars(),this._makeGrad()}get mode(){return this._mode}set mode(e){const i=e|0;if(i>=0&&i<=10&&i!=9)this._mode=i,this._calcBars(),this._makeGrad();else throw new he(ti,e)}get noteLabels(){return this._noteLabels}set noteLabels(e){this._noteLabels=!!e,this._createScales()}get outlineBars(){return this._outlineBars}set outlineBars(e){this._outlineBars=!!e,this._calcBars()}get peakFadeTime(){return this._peakFadeTime}set peakFadeTime(e){this._peakFadeTime=e>=0?+e:this._peakFadeTime||Pe.peakFadeTime}get peakHoldTime(){return this._peakHoldTime}set peakHoldTime(e){this._peakHoldTime=+e||0}get peakLine(){return this._peakLine}set peakLine(e){this._peakLine=!!e}get radial(){return this._radial}set radial(e){this._radial=!!e,this._calcBars(),this._makeGrad()}get radialInvert(){return this._radialInvert}set radialInvert(e){this._radialInvert=!!e,this._calcBars(),this._makeGrad()}get radius(){return this._radius}set radius(e){this._radius=+e||0,this._calcBars(),this._makeGrad()}get reflexRatio(){return this._reflexRatio}set reflexRatio(e){if(e=+e||0,e<0||e>=1)throw new he(ii);this._reflexRatio=e,this._calcBars(),this._makeGrad()}get roundBars(){return this._roundBars}set roundBars(e){this._roundBars=!!e,this._calcBars()}get smoothing(){return this._analyzer[0].smoothingTimeConstant}set smoothing(e){for(const i of[0,1])this._analyzer[i].smoothingTimeConstant=e}get spinSpeed(){return this._spinSpeed}set spinSpeed(e){e=+e||0,(this._spinSpeed===void 0||e==0)&&(this._spinAngle=-at),this._spinSpeed=e}get splitGradient(){return this._splitGradient}set splitGradient(e){this._splitGradient=!!e,this._makeGrad()}get stereo(){return It("stereo","channelLayout"),this._chLayout!=Ae}set stereo(e){It("stereo","channelLayout"),this.channelLayout=e?Re:Ae}get trueLeds(){return this._trueLeds}set trueLeds(e){this._trueLeds=!!e}get volume(){return this._output.gain.value}set volume(e){this._output.gain.value=e}get weightingFilter(){return this._weightingFilter}set weightingFilter(e){this._weightingFilter=$e(e,[Ft,At,yt,Et,St,bt],"toUpperCase")}get width(){return this._width}set width(e){this._width=e,this._setCanvas(nt)}get audioCtx(){return this._input.context}get canvas(){return this._ctx.canvas}get canvasCtx(){return this._ctx}get connectedSources(){return this._sources}get connectedTo(){return this._outNodes}get fps(){return this._fps}get fsHeight(){return this._fsHeight}get fsWidth(){return this._fsWidth}get isAlphaBars(){return this._flg.isAlpha}get isBandsMode(){return this._flg.isBands}get isDestroyed(){return this._destroyed}get isFullscreen(){return this._fsEl&&(document.fullscreenElement||document.webkitFullscreenElement)===this._fsEl}get isLedBars(){return this._flg.isLeds}get isLumiBars(){return this._flg.isLumi}get isOctaveBands(){return this._flg.isOctaves}get isOn(){return!!this._runId}get isOutlineBars(){return this._flg.isOutline}get pixelRatio(){return this._pixelRatio}get isRoundBars(){return this._flg.isRound}static get version(){return Pt}connectInput(e){const i=e instanceof HTMLMediaElement;if(!(i||e.connect))throw new he(si);const s=i?this.audioCtx.createMediaElementSource(e):e;return this._sources.includes(s)||(s.connect(this._input),this._sources.push(s)),s}connectOutput(e=this.audioCtx.destination){if(!this._outNodes.includes(e)&&(this._output.connect(e),this._outNodes.push(e),this._outNodes.length==1))for(const i of[0,1])this._analyzer[i].connect(this._chLayout==Ae&&!i?this._output:this._merger,0,i)}destroy(){if(!this._ready)return;const{audioCtx:e,canvas:i,_controller:s,_input:n,_merger:d,_observer:r,_ownCanvas:l,_ownContext:h,_splitter:E}=this;this._destroyed=!0,this._ready=!1,this.stop(),s.abort(),r&&r.disconnect(),this.onCanvasResize=null,this.onCanvasDraw=null,this._fsEl=null,this.disconnectInput(),this.disconnectOutput(),n.disconnect(),E.disconnect(),d.disconnect(),h&&e.close(),l&&i.remove(),this._calcBars()}disconnectInput(e,i){e?Array.isArray(e)||(e=[e]):e=Array.from(this._sources);for(const s of e){const n=this._sources.indexOf(s);if(i&&s.mediaStream)for(const d of s.mediaStream.getAudioTracks())d.stop();n>=0&&(s.disconnect(this._input),this._sources.splice(n,1))}}disconnectOutput(e){if(!(e&&!this._outNodes.includes(e))&&(this._output.disconnect(e),this._outNodes=e?this._outNodes.filter(i=>i!==e):[],this._outNodes.length==0))for(const i of[0,1])this._analyzer[i].disconnect()}getBars(){return Array.from(this._bars,({posX:e,freq:i,freqLo:s,freqHi:n,hold:d,peak:r,value:l})=>({posX:e,freq:i,freqLo:s,freqHi:n,hold:d,peak:r,value:l}))}getEnergy(e,i){if(e===void 0)return this._energy.val;if(e!=+e){if(e=="peak")return this._energy.peak;const l={bass:[20,250],lowMid:[250,500],mid:[500,2e3],highMid:[2e3,4e3],treble:[4e3,16e3]};if(!l[e])return null;[e,i]=l[e]}const s=this._freqToBin(e),n=i?this._freqToBin(i):s,d=this._chLayout==Ae?1:2;let r=0;for(let l=0;l<d;l++)for(let h=s;h<=n;h++)r+=this._normalizedB(this._fftData[l][h]);return r/(n-s+1)/d}getOptions(e){Array.isArray(e)||(e=[e]);let i={};for(const s of Object.keys(Pe))e.includes(s)||(s=="gradient"&&this.gradientLeft!=this.gradientRight?(i.gradientLeft=this.gradientLeft,i.gradientRight=this.gradientRight):s!="start"&&(i[s]=this[s]));return i}registerGradient(e,i){if(typeof e!="string"||e.trim().length==0)throw new he(ai);if(typeof i!="object")throw new he(ni);const{colorStops:s}=i;if(!Array.isArray(s)||!s.length)throw new he(ri);const n=s.length,d=r=>+r!=r||r<0||r>1;s.forEach((r,l)=>{const h=l/Math.max(1,n-1);typeof r!="object"?s[l]={pos:h,color:r}:d(r.pos)&&(r.pos=h),d(r.level)&&(s[l].level=1-l/n)}),s.sort((r,l)=>r.level<l.level?1:r.level>l.level?-1:0),s[0].level=1,this._gradients[e]={bgColor:i.bgColor||Wt,dir:i.dir,colorStops:s},this._selectedGrads.includes(e)&&this._makeGrad()}setCanvasSize(e,i){this._width=e,this._height=i,this._setCanvas(nt)}setFreqRange(e,i){if(e<1||i<1)throw new he(ot);this._minFreq=Math.min(e,i),this.maxFreq=Math.max(e,i)}setLedParams(e){let i,s,n;e&&(i=e.maxLeds|0,s=+e.spaceV,n=+e.spaceH),this._ledParams=i>0&&s>0&&n>=0?[i,s,n]:void 0,this._calcBars()}setOptions(e){this._setProps(e)}setSensitivity(e,i){for(const s of[0,1])this._analyzer[s].minDecibels=Math.min(e,i),this._analyzer[s].maxDecibels=Math.max(e,i)}start(){this.toggleAnalyzer(!0)}stop(){this.toggleAnalyzer(!1)}toggleAnalyzer(e){const i=this.isOn;return e===void 0&&(e=!i),i&&!e?(cancelAnimationFrame(this._runId),this._runId=0):!i&&e&&!this._destroyed&&(this._frames=0,this._time=performance.now(),this._runId=requestAnimationFrame(s=>this._draw(s))),this.isOn}toggleFullscreen(){if(this.isFullscreen)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{const e=this._fsEl;if(!e)return;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}}_binToFreq(e){return e*this.audioCtx.sampleRate/this.fftSize||1}_calcBars(){const e=this._bars=[];if(!this._ready){this._flg={isAlpha:!1,isBands:!1,isLeds:!1,isLumi:!1,isOctaves:!1,isOutline:!1,isRound:!1,noLedGap:!1};return}const{_ansiBands:i,_barSpace:s,canvas:n,_chLayout:d,_maxFreq:r,_minFreq:l,_mirror:h,_mode:E,_radial:u,_radialInvert:g,_reflexRatio:v}=this,H=n.width>>1,j=n.height>>1,W=d==Re&&!u,U=d==Ve,M=E%10!=0,ae=M&&this._frequencyScale==Ne,R=this._showLeds&&M&&!u,G=this._lumiBars&&M&&!u,ce=this._alphaBars&&!G&&E!=De,Z=this._outlineBars&&M&&!G&&!R,w=this._roundBars&&M&&!G&&!R,Q=d!=Re||v>0&&!G,z=n.height-(W&&!R?.5:0)>>W,Y=z*(G||u?1:1-v)|0,t=n.width-H*(U||h!=0),K=W?n.height-z*2:0,ue=H*(h==-1&&!U&&!u);let le=Math.min(n.width,n.height)*.375*(d==Re?1:this._radius)|0,O=Math.min(H,j);g&&d!=Re&&([le,O]=[O,le]);const x=b=>e.push({...b,peak:[0,0],hold:[0],alpha:[0],value:[0]}),A=b=>{const B=this._freqToBin(b,"floor"),p=this._binToFreq(B),L=this._binToFreq(B+1),F=Math.log2(b/p)/Math.log2(L/p);return[B,F]};let f,q,T;if(ae){const b=(C,N,S)=>+C.toPrecision(S?Math.max(N,1+Math.log10(C)|0):N),B=C=>{const N=[1,1.12,1.25,1.4,1.6,1.8,2,2.24,2.5,2.8,3.15,3.55,4,4.5,5,5.6,6.3,7.1,8,9,10],S=Math.log10(C)|0,ge=C/10**S;let _e=1;for(;_e<N.length&&ge>N[_e];)_e++;return ge-N[_e-1]<N[_e]-ge&&_e--,(N[_e]*10**(S+5)|0)/1e5},p=[0,24,12,8,6,4,3,2,1][E],L=i?10**(3/(p*10)):2**(1/p),F=L**.5;let ee=i?7.94328235/(p%2?1:F):gt;do{let C=ee;const N=b(C/F,4,!0),S=b(C*F,4,!0),[ge,_e]=A(N),[Me,pe]=A(S);i?C=p<4?B(C):b(C,C.toString()[0]<5?3:2):C=b(C,4,!0),C>=l&&x({posX:0,freq:C,freqLo:N,freqHi:S,binLo:ge,binHi:Me,ratioLo:_e,ratioHi:pe}),ee*=L}while(ee<=r);f=t/e.length,e.forEach((C,N)=>C.posX=ue+N*f);const D=e[0],J=e[e.length-1];q=this._freqScaling(D.freqLo),T=t/(this._freqScaling(J.freqHi)-q),D.freqLo<l&&(D.freqLo=l,[D.binLo,D.ratioLo]=A(l)),J.freqHi>r&&(J.freqHi=r,[J.binHi,J.ratioHi]=A(r))}else if(M){const b=[0,24,12,8,6,4,3,2,1][E]*10,B=p=>{switch(this._frequencyScale){case rt:return 1960/(26.81/(p+.53)-1);case lt:return 700*(2**p-1);case qe:return p}};f=t/b,q=this._freqScaling(l),T=t/(this._freqScaling(r)-q);for(let p=0,L=0;p<b;p++,L+=f){const F=B(q+L/T),ee=B(q+(L+f/2)/T),D=B(q+(L+f)/T),[J,C]=A(F),[N,S]=A(D);x({posX:ue+L,freq:ee,freqLo:F,freqHi:D,binLo:J,binHi:N,ratioLo:C,ratioHi:S})}}else{f=1,q=this._freqScaling(l),T=t/(this._freqScaling(r)-q);const b=this._freqToBin(l,"floor"),B=this._freqToBin(r);let p=-999;for(let L=b;L<=B;L++){const F=this._binToFreq(L),ee=ue+Math.round(T*(this._freqScaling(F)-q));if(ee>p)x({posX:ee,freq:F,freqLo:F,freqHi:F,binLo:L,binHi:L,ratioLo:0,ratioHi:0}),p=ee;else if(e.length){const D=e[e.length-1];D.binHi=L,D.freqHi=F,D.freq=(D.freqLo*F)**.5}}}let ie=0,X=0;if(R){const b=this._pixelRatio/(window.devicePixelRatio>1&&window.screen.height<=540?2:1),B=[[],[128,3,.45],[128,4,.225],[96,6,.225],[80,6,.225],[80,6,.125],[64,6,.125],[48,8,.125],[24,16,.125]],p=this._ledParams,[L,F,ee]=p||B[E];let D,J=Y;if(p){const C=2*b;let N;D=L+1;do D--,N=J/D/(1+F),X=N*F;while((N<C||X<C)&&D>1)}else{const C=540/F;X=Math.min(F*b,Math.max(2,J/C+.1|0))}Q&&(J+=X),p||(D=Math.min(L,J/(X*2)|0)),ie=ee>=1?ee:f*ee,this._leds=[D,ie,X,J/D-X]}const y=Math.min(f-1,s*(s>0&&s<1?f:1));M&&(f-=Math.max(R?ie:0,y)),e.forEach((b,B)=>{let p=b.posX,L=f;M&&(s==0&&!R?(p|=0,L|=0,B>0&&p>e[B-1].posX+e[B-1].width&&(p--,L++)):p+=Math.max(R?ie:0,y)/2,b.posX=p),b.barCenter=p+(f==1?0:L/2),b.width=L});const de=[];for(const b of[0,1]){const B=d==Re?(z+K)*b:0,p=B+z,L=B+Y-(!R||Q?0:X);de.push({channelTop:B,channelBottom:p,analyzerBottom:L})}this._aux={analyzerHeight:Y,analyzerWidth:t,centerX:H,centerY:j,channelCoords:de,channelHeight:z,channelGap:K,initialX:ue,innerRadius:le,outerRadius:O,scaleMin:q,unitWidth:T},this._flg={isAlpha:ce,isBands:M,isLeds:R,isLumi:G,isOctaves:ae,isOutline:Z,isRound:w,noLedGap:Q},this._createScales()}_createScales(){if(!this._ready)return;const{analyzerWidth:e,initialX:i,innerRadius:s,scaleMin:n,unitWidth:d}=this._aux,{canvas:r,_frequencyScale:l,_mirror:h,_noteLabels:E,_radial:u,_scaleX:g,_scaleR:v}=this,H=g.canvas,j=v.canvas,W=[],U=this._chLayout==Ve,M=this._chLayout==Re,ae=Math.min(r.width,r.height),R=["C",,"D",,"E","F",,"G",,"A",,"B"],G=ae/34|0,ce=H.height>>1,Z=G>>1,w=ce*(E?.7:1.5),Q=Z*(E?1:2),z=2**(1/12);if(!E&&(this._ansiBands||l!=Ne))W.push(16,31.5,63,125,250,500,1e3,2e3,4e3),l==qe?W.push(6e3,8e3,1e4,12e3,14e3,16e3,18e3,2e4,22e3):W.push(8e3,16e3);else{let O=gt;for(let x=-1;x<11;x++)for(let A=0;A<12;A++){if(O>=this._minFreq&&O<=this._maxFreq){const f=R[A],q=f=="C";(f&&E&&!h&&!U||q)&&W.push(E?[O,f+(q?x:"")]:O)}O*=z}}j.width=j.height=Math.max(ae*.15,(s<<1)+M*G);const Y=j.width>>1,t=Y-G*.7,K=(O,x)=>{const A=Fe*(O/r.width),f=A-at,q=t*Math.cos(f),T=t*Math.sin(f);v.save(),v.translate(Y+q,Y+T),v.rotate(A),v.fillText(x,0,0),v.restore()};H.width|=0,g.fillStyle=v.strokeStyle=jt,g.fillRect(0,0,H.width,H.height),v.arc(Y,Y,Y-G/2,0,Fe),v.lineWidth=G,v.stroke(),g.fillStyle=v.fillStyle=vt,g.font=`${ce}px ${Ye}`,v.font=`${Z}px ${Ye}`,g.textAlign=v.textAlign="center";let ue=-w/4,le=-Q;for(const O of W){const[x,A]=Array.isArray(O)?O:[O,O<1e3?O|0:`${(O/100|0)/10}k`],f=d*(this._freqScaling(x)-n),q=H.height*.75,T=A[0]=="C",ie=ce*(E&&!h&&!U?T?1.2:.6:3);if(g.fillStyle=v.fillStyle=T&&!h&&!U?Qt:vt,E){const X=l==Ne,y=l==qe;let de=["C"];if((X||x>2e3||!y&&x>250||(!u||M)&&(!y&&x>125||x>1e3))&&de.push("G"),(X||x>4e3||!y&&x>500||(!u||M)&&(!y&&x>250||x>2e3))&&de.push("E"),(y&&x>4e3||(!u||M)&&(X||x>2e3||!y&&x>500))&&de.push("D","F","A","B"),!de.includes(A[0]))continue}f>=ue+w/2&&f<=e&&(g.fillText(A,U&&h==-1?e-f:i+f,q,ie),(U||h&&(f>w||h==1))&&g.fillText(A,U&&h!=1?e+f:(i||r.width)-f,q,ie),ue=f+Math.min(ie,g.measureText(A).width)/2),f>=le+Q&&f<e-Q&&(K(U&&h==1?e-f:f,A),(U||h&&(f>Q||h==1))&&K(U&&h!=-1?e+f:-f,A),le=f)}}_draw(e){this._runId=requestAnimationFrame(a=>this._draw(a));const i=e-this._time,s=e-this._last,n=this._maxFPS?975/this._maxFPS:0;if(s<n)return;this._last=e-(n?s%n:0),this._frames++,i>=1e3&&(this._fps=this._frames/i*1e3,this._frames=0,this._time=e);const{isAlpha:d,isBands:r,isLeds:l,isLumi:h,isOctaves:E,isOutline:u,isRound:g,noLedGap:v}=this._flg,{analyzerHeight:H,centerX:j,centerY:W,channelCoords:U,channelHeight:M,channelGap:ae,initialX:R,innerRadius:G,outerRadius:ce}=this._aux,{_bars:Z,canvas:w,_canvasGradients:Q,_chLayout:z,_colorMode:Y,_ctx:t,_energy:K,_fadePeaks:ue,fillAlpha:le,_fps:O,_linearAmplitude:x,_lineWidth:A,maxDecibels:f,minDecibels:q,_mirror:T,_mode:ie,overlay:X,_radial:y,showBgColor:de,showPeaks:b,useCanvas:B,_weightingFilter:p}=this,L=this._scaleX.canvas,F=this._scaleR.canvas,ee=O*this._peakFadeTime/1e3,D=O**2,J=this._gravity*1e3,C=O*this._peakHoldTime/1e3,N=z==pt,S=z==Ve,ge=z==Re,_e=z==Ae,Me=l&&this._trueLeds&&Y==je,pe=y?w.width:this._aux.analyzerWidth,Qe=R+pe,Ge=b&&this._peakLine&&ie==De,ye=y?ce-G:H,Nt=ye/this._pixelRatio,[Mt,oi,He,Ke]=this._leds||[];K.val>0&&O>0&&(this._spinAngle+=this._spinSpeed*Fe/60/O);const Gt=a=>{if(this._reflexRatio>0&&!h&&!y){let m,me;this.reflexFit||ge?(m=ge&&a==0?M+ae:0,me=M-H):(m=w.height-H*2,me=H),t.save(),t.globalAlpha=this.reflexAlpha,this.reflexBright!=1&&(t.filter=`brightness(${this.reflexBright})`),t.setTransform(1,0,0,-1,0,w.height),t.drawImage(w,0,U[a].channelTop,w.width,H,0,m,w.width,me),t.restore()}},Ht=()=>{this.showScaleX&&(y?(t.save(),t.translate(j,W),this._spinSpeed&&t.rotate(this._spinAngle+at),t.drawImage(F,-F.width>>1,-F.width>>1),t.restore()):t.drawImage(L,0,w.height-L.height))},zt=a=>{const m=a**2,me=424.36,$=11599.29,Xe=25122.25,Ee=544496.41,we=148693636,Te=ve=>20*Math.log10(ve);switch(p){case At:const ve=we*m**2/((m+me)*Math.sqrt((m+$)*(m+Ee))*(m+we));return 2+Te(ve);case yt:const xe=we*m*a/((m+me)*Math.sqrt(m+Xe)*(m+we));return .17+Te(xe);case Et:const et=we*m/((m+me)*(m+we));return .06+Te(et);case St:const We=((103791848e-2-m)**2+108076816e-2*m)/((9837328-m)**2+11723776*m),tt=a/68966888496476e-18*Math.sqrt(We/((m+79919.29)*(m+1345600)));return Te(tt);case bt:const Ue=-4737338981378384e-39*a**6+2043828333606125e-30*a**4-1363894795463638e-22*m+1,Be=1306612257412824e-34*a**5-2118150887518656e-26*a**3+.0005559488023498642*a,ne=.0001246332637532143*a/Math.hypot(Ue,Be);return 18.2+Te(ne)}return 0},Je=(a,m,me)=>{t.beginPath(),t.moveTo(a,m),t.lineTo(a,me),t.stroke()},Ze=a=>{if(a&&A){const m=t.globalAlpha;t.globalAlpha=1,t.stroke(),t.globalAlpha=m}},Ce=a=>Math.max(0,(a*Mt|0)*(Ke+He)-He),qt=a=>{K.val=a,K.peak>0&&(K.hold--,K.hold<0&&(K.peak+=K.hold*J/D/w.height*this._pixelRatio)),a>=K.peak&&(K.peak=a,K.hold=C)};X&&t.clearRect(0,0,w.width,w.height);let ct=0;const dt=Z.length,_t=_e?1:2;for(let a=0;a<_t;a++){const{channelTop:m,channelBottom:me,analyzerBottom:$}=U[a],Xe=this._gradients[this._selectedGrads[a]],Ee=Xe.colorStops,we=Ee.length,Te=!de||l&&!X?"#000":Xe.bgColor,ve=ge&&y&&a?-1:1,xe=!a&&T==-1||a&&T==1,et=!S||a&&T!=1?0:pe>>(a||!xe),We=S&&xe?-1:1,tt=()=>{const o=L.height,c=o>>1,_=x?100:f,k=x?0:q,P=x?20:5,se=H/(_-k),Le=T!=-1&&(!S||a==0||T==1),Se=T!=1&&(!S||a!=T);t.save(),t.fillStyle=xt,t.font=`${c}px ${Ye}`,t.textAlign="right",t.lineWidth=1;for(let be=_;be>k;be-=P){const Oe=m+(_-be)*se,V=be%2==0|0;if(V){const te=Oe+c*(Oe==m?.8:.35);Le&&t.fillText(be,o*.85,te),Se&&t.fillText(be,(S?pe:w.width)-o*.1,te),t.strokeStyle=xt,t.setLineDash([2,4]),t.lineDashOffset=0}else t.strokeStyle=Kt,t.setLineDash([2,8]),t.lineDashOffset=1;t.beginPath(),t.moveTo(R+o*V*Le,~~Oe+.5),t.lineTo(Qe-o*V*Se,~~Oe+.5),t.stroke()}t.restore()},Ue=(o,c)=>{const _=fe[o]+(o<fe.length-1?(fe[o+1]-fe[o])*c:0);return isNaN(_)?-1/0:_},Be=(o,c=We)=>c*Fe*((o+et)/w.width)+this._spinAngle,ne=(o,c,_)=>{const k=G+c*ve,P=Be(o,_);return[j+k*Math.cos(P),W+k*Math.sin(P)]},it=(o,c,_,k,P)=>{t.beginPath();for(const se of T&&!S?[1,-1]:[We]){const[Le,Se]=g?[Be(o,se),Be(o+_,se)]:[];t.moveTo(...ne(o,c,se)),t.lineTo(...ne(o,c+k,se)),g?t.arc(j,W,G+(c+k)*ve,Le,Se,se!=1):t.lineTo(...ne(o+_,c+k,se)),t.lineTo(...ne(o+_,c,se)),g&&!P&&t.arc(j,W,G+c*ve,Se,Le,se==1)}Ze(P),t.fill()},st=(o=0,c=0)=>{let _;if(Y==je&&!Me||ie==De)_=Q[a];else{const k=Y==mt?c%we:Ee.findLastIndex(P=>l?Ce(o)<=Ce(P.level):o<=P.level);_=Ee[k].color}t.fillStyle=t.strokeStyle=_};if(B){if(S&&!y){const o=pe*(a+xe),c=xe?-1:1;t.setTransform(c,0,0,1,o,0)}if((!X||de)&&(X&&(t.globalAlpha=this.bgAlpha),t.fillStyle=Te,(a==0||!y&&!N)&&t.fillRect(R,m-ae,pe,(X&&this.reflexAlpha==1?H:M)+ae),t.globalAlpha=1),this.showScaleY&&!h&&!y&&(a==0||!N)&&tt(),l?(t.setLineDash([Ke,He]),t.lineWidth=Z[0].width):t.lineWidth=u?Math.min(A,Z[0].width/2):A,t.save(),!y){const o=new Path2D;o.rect(0,m,w.width,H),t.clip(o)}}let fe=this._fftData[a];this._analyzer[a].getFloatFrequencyData(fe),p&&(fe=fe.map((o,c)=>o+zt(this._binToFreq(c)))),t.beginPath();let ze=[];for(let o=0;o<dt;o++){const c=Z[o],{posX:_,barCenter:k,width:P,freq:se,binLo:Le,binHi:Se,ratioLo:be,ratioHi:Oe}=c;let V=Math.max(Ue(Le,be),Ue(Se,Oe));for(let I=Le+1;I<Se;I++)fe[I]>V&&(V=fe[I]);if(V=this._normalizedB(V),c.value[a]=V,ct+=V,c.peak[a]>0&&c.alpha[a]>0&&(c.hold[a]--,c.hold[a]<0)){if(ue&&!Ge){const I=!d||u&&A>0?1:d?c.peak[a]:le;c.alpha[a]=I*(1+c.hold[a]/ee)}else c.peak[a]+=c.hold[a]*J/D/Nt;c.alpha[a]<=0&&(c.peak[a]=0)}if(V>=c.peak[a]&&(c.peak[a]=V,c.hold[a]=C,c.alpha[a]=!d||u&&A>0?1:d?V:le),!B)continue;t.globalAlpha=h||d?V:u?le:1,st(V,o);const te=h?ye:l?Ce(V):V*ye|0;if(ie==De){const I=o?0:(this._normalizedB(fe[Z[1].binLo])*ye+te)/2;if(y){if(o==0&&(S&&t.moveTo(...ne(0,0)),t.lineTo(...ne(0,_<0?I:te))),_>=0){const oe=[_,te];t.lineTo(...ne(...oe)),ze.push(oe)}}else{if(o==0)if(T==-1&&!S)t.moveTo(R,$-(_<R?I:te));else{const oe=Le?this._normalizedB(fe[Le-1])*ye:te;t.moveTo(R-A,$-oe)}(S||T!=-1||_>=R)&&t.lineTo(_,$-te)}}else if(l){if(de&&!X&&(a==0||!N)){const I=t.globalAlpha;t.strokeStyle=Vt,t.globalAlpha=1,Je(k,m,$),t.strokeStyle=t.fillStyle,t.globalAlpha=I}if(Me){const I=h?0:Ee.findLastIndex(Ie=>Ce(V)<=Ce(Ie.level));let oe=$;for(let Ie=we-1;Ie>=I;Ie--){t.strokeStyle=Ee[Ie].color;let ut=$-(Ie==I?te:Ce(Ee[Ie].level));Je(k,oe,ut),oe=ut-He}}else Je(k,$,$-te)}else if(_>=R)if(y)it(_,0,P,te,u);else if(g){const I=P/2,oe=$+I;t.beginPath(),t.moveTo(_,oe),t.lineTo(_,oe-te),t.arc(k,oe-te,I,ht,Fe),t.lineTo(_+P,oe),Ze(u),t.fill()}else{const I=u?t.lineWidth:0;t.beginPath(),t.rect(_,$+I,P,-te-I),Ze(u),t.fill()}const ke=c.peak[a],ft=c.alpha[a];if(ke>0&&ft>0&&b&&!Ge&&!h&&_>=R&&_<Qe){if(ue?t.globalAlpha=ft:u&&A>0?t.globalAlpha=1:d&&(t.globalAlpha=ke),(Y==Lt||Me)&&st(ke),l){const I=Ce(ke);I>=He&&t.fillRect(_,$-I,P,Ke)}else if(!y)t.fillRect(_,$-ke*ye,P,2);else if(ie!=De){const I=ke*ye;it(_,I,P,!this._radialInvert||ge||I+G>=2?-2:2)}}}if(B){if(t.globalAlpha=1,ie==De){if(st(),y&&!S){if(T){let o;for(;o=ze.pop();)t.lineTo(...ne(...o,-1))}t.closePath()}if(A>0&&t.stroke(),le>0){if(y){const o=S?Be(pe>>1):0,c=S?Be(pe):Fe;t.moveTo(...ne(S?pe>>1:0,0)),t.arc(j,W,G,o,c,S?!xe:!0)}else t.lineTo(Qe,$),t.lineTo(R,$);t.globalAlpha=le,t.fill(),t.globalAlpha=1}if((Ge||y&&b)&&(ze=[],t.beginPath(),Z.forEach((o,c)=>{let _=o.posX,k=o.peak[a],P=c?"lineTo":"moveTo";if(y&&_<0){const se=Z[c+1];k=li(_,k,se.posX,se.peak[a],0),_=0}k*=ye,Ge?(t[P](...y?ne(_,k):[_,$-k]),y&&T&&!S&&ze.push([_,k])):k>0&&it(_,k,1,-2)}),Ge)){let o;for(;o=ze.pop();)t.lineTo(...ne(...o,-1));t.lineWidth=1,t.stroke()}}t.restore(),S&&!y&&t.setTransform(1,0,0,1,0,0),(!S&&!N||a)&&Gt(a)}}if(qt(ct/(dt<<_t-1)),B&&(T&&!y&&!S&&(t.setTransform(-1,0,0,1,w.width-R,0),t.drawImage(w,R,0,j,w.height,0,0,j,w.height),t.setTransform(1,0,0,1,0,0)),t.setLineDash([]),Ht()),this.showFPS){const a=L.height;t.font=`bold ${a}px ${Ye}`,t.fillStyle=Ut,t.textAlign="right",t.fillText(Math.round(O),w.width-a,a*2)}this.onCanvasDraw&&(t.save(),t.fillStyle=t.strokeStyle=Q[0],this.onCanvasDraw(this,{timestamp:e,canvasGradients:Q}),t.restore())}_freqScaling(e){switch(this._frequencyScale){case Ne:return Math.log2(e);case rt:return 26.81*e/(1960+e)-.53;case lt:return Math.log2(1+e/700);case qe:return e}}_freqToBin(e,i="round"){const s=this._analyzer[0].frequencyBinCount-1,n=Math[i](e*this.fftSize/this.audioCtx.sampleRate);return n<s?n:s}_makeGrad(){if(!this._ready)return;const{canvas:e,_ctx:i,_radial:s,_reflexRatio:n}=this,{analyzerWidth:d,centerX:r,centerY:l,initialX:h,innerRadius:E,outerRadius:u}=this._aux,{isLumi:g}=this._flg,v=this._chLayout==Re,H=1-n,j=g?e.height:e.height*(1-n*!v)|0;for(const W of[0,1]){const U=this._gradients[this._selectedGrads[W]],M=U.colorStops,ae=U.dir=="h";let R;if(s?R=i.createRadialGradient(r,l,u,r,l,E-(u-E)*v):R=i.createLinearGradient(...ae?[h,0,h+d,0]:[0,0,0,j]),M){const G=v&&!this._splitGradient&&(!ae||s);for(let ce=0;ce<1+G;ce++){const Z=M.length-1;M.forEach((w,Q)=>{let z=w.pos;if(G&&(z/=2),v&&!g&&!s&&!ae&&(z*=H,!G&&z>.5*H&&(z+=.5*n)),ce==1)if(s||g){const Y=Z-Q;w=M[Y],z=1-w.pos/2}else Q==0&&z>0&&R.addColorStop(.5,w.color),z+=.5;R.addColorStop(z,w.color),v&&Q==Z&&z<.5&&R.addColorStop(.5,w.color)})}}this._canvasGradients[W]=R}}_normalizedB(e){const i=this._linearAmplitude,s=i?1/this._linearBoost:1,n=(h,E,u)=>h<=E?E:h>=u?u:h,d=h=>10**(h/20);let r=this.maxDecibels,l=this.minDecibels;return i&&(r=d(r),l=d(l),e=d(e)**s),n((e-l)/(r-l)**s,0,1)}_setCanvas(e){if(!this._ready)return;const{canvas:i,_ctx:s}=this,n=this._scaleX.canvas,d=window.devicePixelRatio/(this._loRes+1);let r=window.screen.width*d,l=window.screen.height*d;Math.abs(window.orientation)==90&&r<l&&([r,l]=[l,r]);const h=this.isFullscreen,E=h&&this._fsEl==i,u=E?r:(this._width||this._container.clientWidth||this._defaultWidth)*d|0,g=E?l:(this._height||this._container.clientHeight||this._defaultHeight)*d|0;this._pixelRatio=d,this._fsWidth=r,this._fsHeight=l,!(e!=Ct&&i.width==u&&i.height==g)&&(i.width=u,i.height=g,this.overlay||(s.fillStyle="#000",s.fillRect(0,0,u,g)),s.lineJoin="bevel",n.width=u,n.height=Math.max(20*d,Math.min(u,g)/32|0),this._calcBars(),this._makeGrad(),this._fsStatus!==void 0&&this._fsStatus!==h&&(e=Tt),this._fsStatus=h,this.onCanvasResize&&this.onCanvasResize(e,this))}_setGradient(e,i){if(!this._gradients.hasOwnProperty(e))throw new he(ei,e);[0,1].includes(i)||(this._selectedGrads[1]=e,i=0),this._selectedGrads[i]=e,this._makeGrad()}_setProps(e,i){const s=["onCanvasDraw","onCanvasResize"],n=["gradientLeft","gradientRight","stereo"],d=Object.keys(Pe).filter(r=>r!="start").concat(s,n);(i||e===void 0)&&(e={...Pe,...e});for(const r of Object.keys(e))s.includes(r)&&typeof e[r]!="function"?this[r]=void 0:d.includes(r)&&(this[r]=e[r]);e.start!==void 0&&this.toggleAnalyzer(e.start)}}export{hi as AudioMotionAnalyzer,hi as default};
