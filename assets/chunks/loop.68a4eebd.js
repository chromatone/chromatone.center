import{t as v}from"./tempo.60cef874.js";import{r as E}from"./calculations.65ee336d.js";import{g as y}from"./colors.f742d7d3.js";import{F as S,X as F,s as M,H as P,t as A,Y as C,Z as x}from"./index.cccf7ef0.js";import{a as B}from"./midi.231bd883.js";import{b as g,c as D}from"./midiRender.54408243.js";import{c as R}from"./audio.e9cddac8.js";import{b as n}from"./index.25d7e705.js";import{S as T}from"./Sequence.ac2a9b47.js";import{B as $,i as b,A as N,G as h,K as j}from"./framework.f429e15e.js";import{P as O,M as q}from"./synth.15b1a9f8.js";const w=$([]);function z(s=0){const e=$({pitch:b(()=>y.tonic),chroma:b(()=>y.set.chroma),metre:{over:n(`grid-${s}-over`,4),under:n(`grid-${s}-under`,4)},octave:n(`grid-${s}-octave`,3),volume:n(`grid-${s}-vol`,1),pan:n(`grid-${s}-pan`,s%2==1?-.5:.5),probability:n(`grid-${s}-probability`,1),tonic:b(()=>e.pitch+12*e.octave-3),steps:n(`grid-${s}-steps`,[]),current:[],progress:b(()=>v.ticks?t==null?void 0:t.progress:0),clear(){e.steps.forEach((r,o)=>{e.steps[o]=[{}]})},rotate(r=1){e.steps=E(e.steps,r)}});w[s]=e;const{channel:m}=R(`grid-loop-${s}`),a=new F(e.pan,0).connect(m),p=new O().connect(a);p.maxPolyphony=100;let t=new T((r,o)=>{c(o,r)},e.steps,e.metre.under+"n").start(0);N(()=>e.metre.under,()=>{t.stop().dispose(),t=new T((r,o)=>{c(o,r)},e.steps,e.metre.under+"n").start(0),t.probability=e.probability}),N(()=>e.metre.over,()=>{if(e.steps.length>e.metre.over)e.steps.length=e.metre.over;else for(let r=e.steps.length;r<e.metre.over;r++)e.steps.push([{}]);t.events=e.steps},{immediate:!0}),h(()=>{t.events=e.steps}),h(()=>{v.stopped&&(e.current=null)}),h(()=>{t.probability=e.probability,a.volume.targetRampTo(M(e.volume),1),a.pan.targetRampTo(e.pan,1)});function c(r,o){P.state=="suspended"&&A();let u=Object.entries(r).map(i=>{if(i[0]!="sub")return i[1]?q(Number(i[0])+e.tonic):null}).filter(Number);p.triggerAttackRelease(u,{[e.metre.under+"n"]:1/(r.sub||1)},o),C.schedule(()=>{let i=x({[e.metre.under+"n"]:1/(r.sub||1)}).toMilliseconds(),f=u.map(d=>d.toMidi());B(f,{duration:i,attack:e.volume})},o)}return j(()=>{w.splice(s,1),t.stop().dispose(),a.dispose(),p.dispose()}),e}function J(){let s=[];w.forEach((m,a)=>{let p=512/m.metre.under,t=new g.Track;t.setTempo(v.bpm,0),t.addInstrumentName("piano"),t.addTrackName("Chromatone grid "+a),t.setTimeSignature(4,4),m.steps.forEach((c,r)=>{c.forEach((o,u)=>{let i=u,f=r,d=p/c.length,k=Object.entries(o).map(l=>l[1]==!0?Number(l[0])+m.tonic:null).filter(l=>Number(l)).map(l=>S(l,"midi").toNote());t.addEvent(new g.NoteEvent({pitch:k,duration:`T${d}`,startTick:p*f+i*d,velocity:m.volume*100}))})}),s[a]=t});var e=new g.Writer(s);D(e.buildFile(),"Chromatone-grid")}export{J as r,z as u};
