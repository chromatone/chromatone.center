import{t as v}from"./tempo.84043c62.js";import{r as A}from"./calculations.2bac3e9a.js";import{g as y}from"./colors.71e97f2b.js";import{F as C,N as E,y as M,L as S,s as F,D as P,Q as D}from"./index.e98b5e67.js";import{m as j}from"./midi.b5556f9f.js";import{M as h,c as q}from"./midiRender.1914f0ed.js";import{c as x}from"./audio.e7507cf6.js";import{u as p}from"./index.70261d75.js";import{S as T}from"./Sequence.873f0209.js";import{k,j as f,w as N,z as g,B}from"./framework.88db3c26.js";import{P as L,M as R}from"./synth.9919606b.js";function O(t){let e,i=t[0],o=1;for(;o<t.length;){const n=t[o],r=t[o+1];if(o+=2,(n==="optionalAccess"||n==="optionalCall")&&i==null)return;n==="access"||n==="optionalAccess"?(e=i,i=r(i)):(n==="call"||n==="optionalCall")&&(i=r((...l)=>i.call(e,...l)),e=void 0)}return i}const w=k([]);function X(t=0){const e=k({pitch:f(()=>y.tonic),chroma:f(()=>y.set.chroma),metre:{over:p(`grid-${t}-over`,4),under:p(`grid-${t}-under`,4)},octave:p(`grid-${t}-octave`,3),volume:p(`grid-${t}-vol`,1),pan:p(`grid-${t}-pan`,t%2==1?-.5:.5),probability:p(`grid-${t}-probability`,1),tonic:f(()=>e.pitch+12*e.octave-3),steps:p(`grid-${t}-steps`,[]),current:[],progress:f(()=>v.ticks?O([r,"optionalAccess",s=>s.progress]):0),clear(){e.steps.forEach((s,a)=>{e.steps[a]=[{}]})},rotate(s=1){e.steps=A(e.steps,s)}});w[t]=e;const{channel:i}=x(`grid-loop-${t}`),o=new E(e.pan,0).connect(i),n=new L().connect(o);n.maxPolyphony=100;let r=new T((s,a)=>{l(a,s)},e.steps,e.metre.under+"n").start(0);N(()=>e.metre.under,()=>{r.stop().dispose(),r=new T((s,a)=>{l(a,s)},e.steps,e.metre.under+"n").start(0),r.probability=e.probability}),N(()=>e.metre.over,()=>{if(e.steps.length>e.metre.over)e.steps.length=e.metre.over;else for(let s=e.steps.length;s<e.metre.over;s++)e.steps.push([{}]);r.events=e.steps},{immediate:!0}),g(()=>{r.events=e.steps}),g(()=>{v.stopped&&(e.current=null)}),g(()=>{r.probability=e.probability,o.volume.targetRampTo(M(e.volume),1),o.pan.targetRampTo(e.pan,1)});function l(s,a){S.state=="suspended"&&F();let u=Object.entries(s).map(c=>{if(c[0]!="sub")return c[1]?R(Number(c[0])+e.tonic):null}).filter(Number);n.triggerAttackRelease(u,{[e.metre.under+"n"]:1/(s.sub||1)},a),P.schedule(()=>{let c=D({[e.metre.under+"n"]:1/(s.sub||1)}).toMilliseconds(),b=u.map(d=>d.toMidi());j(b,{duration:c,attack:e.volume})},a)}return B(()=>{w.splice(t,1),r.stop().dispose(),o.dispose(),n.dispose()}),e}function Y(){let t=[];w.forEach((i,o)=>{let n=512/i.metre.under,r=new h.Track;r.setTempo(v.bpm,0),r.addInstrumentName("piano"),r.addTrackName("Chromatone grid "+o),r.setTimeSignature(4,4,24,8),i.steps.forEach((l,s)=>{l.forEach((a,u)=>{let c=u,b=s,d=n/l.length,$=Object.entries(a).map(m=>m[1]==!0?Number(m[0])+i.tonic:null).filter(m=>Number(m)).map(m=>C(m,"midi").toNote());r.addEvent(new h.NoteEvent({pitch:$,duration:`T${d}`,startTick:n*b+c*d,velocity:i.volume*100}))})}),t[o]=r});var e=new h.Writer(t);q(e.buildFile(),"Chromatone-grid")}export{Y as r,X as u};
