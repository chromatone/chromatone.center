import{t as v}from"./tempo.a46486f1.js";import{r as A}from"./calculations.2bac3e9a.js";import{g as y}from"./colors.93330ee5.js";import{F as C,Y as E,s as M,J as S,t as F,Z as P,$ as j}from"./index.3012fc8f.js";import{m as q}from"./midi.0fea24b9.js";import{M as h,c as x}from"./midiRender.ed5d5da0.js";import{c as D}from"./audio.e0c178f7.js";import{k as $,j as f,v as p,w as T,J as g,N as R}from"./framework.2f46aeb8.js";import{S as N}from"./Sequence.9d91054d.js";import{P as B,M as J}from"./synth.05e847c0.js";function L(t){let e,n=t[0],o=1;for(;o<t.length;){const i=t[o],s=t[o+1];if(o+=2,(i==="optionalAccess"||i==="optionalCall")&&n==null)return;i==="access"||i==="optionalAccess"?(e=n,n=s(n)):(i==="call"||i==="optionalCall")&&(n=s((...l)=>n.call(e,...l)),e=void 0)}return n}const w=$([]);function G(t=0){const e=$({pitch:f(()=>y.tonic),chroma:f(()=>y.set.chroma),metre:{over:p(`grid-${t}-over`,4),under:p(`grid-${t}-under`,4)},octave:p(`grid-${t}-octave`,3),volume:p(`grid-${t}-vol`,1),pan:p(`grid-${t}-pan`,t%2==1?-.5:.5),probability:p(`grid-${t}-probability`,1),tonic:f(()=>e.pitch+12*e.octave-3),steps:p(`grid-${t}-steps`,[]),current:[],progress:f(()=>v.ticks?L([s,"optionalAccess",r=>r.progress]):0),clear(){e.steps.forEach((r,a)=>{e.steps[a]=[{}]})},rotate(r=1){e.steps=A(e.steps,r)}});w[t]=e;const{channel:n}=D(`grid-loop-${t}`),o=new E(e.pan,0).connect(n),i=new B().connect(o);i.maxPolyphony=100;let s=new N((r,a)=>{l(a,r)},e.steps,e.metre.under+"n").start(0);T(()=>e.metre.under,()=>{s.stop().dispose(),s=new N((r,a)=>{l(a,r)},e.steps,e.metre.under+"n").start(0),s.probability=e.probability}),T(()=>e.metre.over,()=>{if(e.steps.length>e.metre.over)e.steps.length=e.metre.over;else for(let r=e.steps.length;r<e.metre.over;r++)e.steps.push([{}]);s.events=e.steps},{immediate:!0}),g(()=>{s.events=e.steps}),g(()=>{v.stopped&&(e.current=null)}),g(()=>{s.probability=e.probability,o.volume.targetRampTo(M(e.volume),1),o.pan.targetRampTo(e.pan,1)});function l(r,a){S.state=="suspended"&&F();let u=Object.entries(r).map(c=>{if(c[0]!="sub")return c[1]?J(Number(c[0])+e.tonic):null}).filter(Number);i.triggerAttackRelease(u,{[e.metre.under+"n"]:1/(r.sub||1)},a),P.schedule(()=>{let c=j({[e.metre.under+"n"]:1/(r.sub||1)}).toMilliseconds(),b=u.map(d=>d.toMidi());q(b,{duration:c,attack:e.volume})},a)}return R(()=>{w.splice(t,1),s.stop().dispose(),o.dispose(),i.dispose()}),e}function K(){let t=[];w.forEach((n,o)=>{let i=512/n.metre.under,s=new h.Track;s.setTempo(v.bpm,0),s.addInstrumentName("piano"),s.addTrackName("Chromatone grid "+o),s.setTimeSignature(4,4,24,8),n.steps.forEach((l,r)=>{l.forEach((a,u)=>{let c=u,b=r,d=i/l.length,k=Object.entries(a).map(m=>m[1]==!0?Number(m[0])+n.tonic:null).filter(m=>Number(m)).map(m=>C(m,"midi").toNote());s.addEvent(new h.NoteEvent({pitch:k,duration:`T${d}`,startTick:i*b+c*d,velocity:n.volume*100}))})}),t[o]=s});var e=new h.Writer(t);x(e.buildFile(),"Chromatone-grid")}export{K as r,G as u};
