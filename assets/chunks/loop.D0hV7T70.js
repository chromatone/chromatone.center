import{t as v}from"./tempo.tDAToNwG.js";import{r as A}from"./calculations.uITx2GSi.js";import{g as y}from"./colors.DQ3Nq55L.js";import{F as C,N as E,y as M,L as S,s as D,D as F,Q as P}from"./index.RYxauP_R.js";import{m as j}from"./midi.JUoUGMo3.js";import{M as h,c as q}from"./midiRender.uVc9GHxZ.js";import{c as x}from"./audio.MFPk3EpQ.js";import{k,j as f,v as p,w as T,D as g,G as L}from"./framework.1uYGFCry.js";import{S as N}from"./Sequence.kPz-JF-q.js";import{P as R,M as B}from"./synth.CftW3DNb.js";function O(t){let e,n=t[0],o=1;for(;o<t.length;){const i=t[o],s=t[o+1];if(o+=2,(i==="optionalAccess"||i==="optionalCall")&&n==null)return;i==="access"||i==="optionalAccess"?(e=n,n=s(n)):(i==="call"||i==="optionalCall")&&(n=s((...l)=>n.call(e,...l)),e=void 0)}return n}const w=k([]);function K(t=0){const e=k({pitch:f(()=>y.tonic),chroma:f(()=>y.set.chroma),metre:{over:p(`grid-${t}-over`,4),under:p(`grid-${t}-under`,4)},octave:p(`grid-${t}-octave`,3),volume:p(`grid-${t}-vol`,1),pan:p(`grid-${t}-pan`,t%2==1?-.5:.5),probability:p(`grid-${t}-probability`,1),tonic:f(()=>e.pitch+12*e.octave-3),steps:p(`grid-${t}-steps`,[]),current:[],progress:f(()=>v.ticks?O([s,"optionalAccess",r=>r.progress]):0),clear(){e.steps.forEach((r,a)=>{e.steps[a]=[{}]})},rotate(r=1){e.steps=A(e.steps,r)}});w[t]=e;const{channel:n}=x(`grid-loop-${t}`),o=new E(e.pan,0).connect(n),i=new R().connect(o);i.maxPolyphony=100;let s=new N((r,a)=>{l(a,r)},e.steps,e.metre.under+"n").start(0);T(()=>e.metre.under,()=>{s.stop().dispose(),s=new N((r,a)=>{l(a,r)},e.steps,e.metre.under+"n").start(0),s.probability=e.probability}),T(()=>e.metre.over,()=>{if(e.steps.length>e.metre.over)e.steps.length=e.metre.over;else for(let r=e.steps.length;r<e.metre.over;r++)e.steps.push([{}]);s.events=e.steps},{immediate:!0}),g(()=>{s.events=e.steps}),g(()=>{v.stopped&&(e.current=null)}),g(()=>{s.probability=e.probability,o.volume.targetRampTo(M(e.volume),1),o.pan.targetRampTo(e.pan,1)});function l(r,a){S.state=="suspended"&&D();let u=Object.entries(r).map(c=>{if(c[0]!="sub")return c[1]?B(Number(c[0])+e.tonic):null}).filter(Number);i.triggerAttackRelease(u,{[e.metre.under+"n"]:1/(r.sub||1)},a),F.schedule(()=>{let c=P({[e.metre.under+"n"]:1/(r.sub||1)}).toMilliseconds(),b=u.map(d=>d.toMidi());j(b,{duration:c,attack:e.volume})},a)}return L(()=>{w.splice(t,1),s.stop().dispose(),o.dispose(),i.dispose()}),e}function X(){let t=[];w.forEach((n,o)=>{let i=512/n.metre.under,s=new h.Track;s.setTempo(v.bpm,0),s.addInstrumentName("piano"),s.addTrackName("Chromatone grid "+o),s.setTimeSignature(4,4,24,8),n.steps.forEach((l,r)=>{l.forEach((a,u)=>{let c=u,b=r,d=i/l.length,$=Object.entries(a).map(m=>m[1]==!0?Number(m[0])+n.tonic:null).filter(m=>Number(m)).map(m=>C(m,"midi").toNote());s.addEvent(new h.NoteEvent({pitch:$,duration:`T${d}`,startTick:i*b+c*d,velocity:n.volume*100}))})}),t[o]=s});var e=new h.Writer(t);q(e.buildFile(),"Chromatone-grid")}export{X as r,K as u};
