import{t as v}from"./tempo.8fdc091e.js";import{r as C}from"./calculations.97c9b876.js";import{g as y}from"./colors.7c5ce8ba.js";import{F as A,Y as E,s as M,J as S,t as F,Z as P,$ as q}from"./index.b4e3491a.js";import{a as x}from"./midi.732209b1.js";import{M as h,c as B}from"./midiRender.5036047c.js";import{c as D}from"./audio.63c56e5f.js";import{C as $,i as f,H as p,B as T,N as g,W as R}from"./framework.7e580a04.js";import{S as N}from"./Sequence.73dbf5c1.js";import{P as W,M as j}from"./synth.ee1f5a0a.js";function H(t){let e,i=t[0],o=1;for(;o<t.length;){const n=t[o],s=t[o+1];if(o+=2,(n==="optionalAccess"||n==="optionalCall")&&i==null)return;n==="access"||n==="optionalAccess"?(e=i,i=s(i)):(n==="call"||n==="optionalCall")&&(i=s((...l)=>i.call(e,...l)),e=void 0)}return i}const w=$([]);function G(t=0){const e=$({pitch:f(()=>y.tonic),chroma:f(()=>y.set.chroma),metre:{over:p(`grid-${t}-over`,4),under:p(`grid-${t}-under`,4)},octave:p(`grid-${t}-octave`,3),volume:p(`grid-${t}-vol`,1),pan:p(`grid-${t}-pan`,t%2==1?-.5:.5),probability:p(`grid-${t}-probability`,1),tonic:f(()=>e.pitch+12*e.octave-3),steps:p(`grid-${t}-steps`,[]),current:[],progress:f(()=>v.ticks?H([s,"optionalAccess",r=>r.progress]):0),clear(){e.steps.forEach((r,a)=>{e.steps[a]=[{}]})},rotate(r=1){e.steps=C(e.steps,r)}});w[t]=e;const{channel:i}=D(`grid-loop-${t}`),o=new E(e.pan,0).connect(i),n=new W().connect(o);n.maxPolyphony=100;let s=new N((r,a)=>{l(a,r)},e.steps,e.metre.under+"n").start(0);T(()=>e.metre.under,()=>{s.stop().dispose(),s=new N((r,a)=>{l(a,r)},e.steps,e.metre.under+"n").start(0),s.probability=e.probability}),T(()=>e.metre.over,()=>{if(e.steps.length>e.metre.over)e.steps.length=e.metre.over;else for(let r=e.steps.length;r<e.metre.over;r++)e.steps.push([{}]);s.events=e.steps},{immediate:!0}),g(()=>{s.events=e.steps}),g(()=>{v.stopped&&(e.current=null)}),g(()=>{s.probability=e.probability,o.volume.targetRampTo(M(e.volume),1),o.pan.targetRampTo(e.pan,1)});function l(r,a){S.state=="suspended"&&F();let u=Object.entries(r).map(c=>{if(c[0]!="sub")return c[1]?j(Number(c[0])+e.tonic):null}).filter(Number);n.triggerAttackRelease(u,{[e.metre.under+"n"]:1/(r.sub||1)},a),P.schedule(()=>{let c=q({[e.metre.under+"n"]:1/(r.sub||1)}).toMilliseconds(),b=u.map(d=>d.toMidi());x(b,{duration:c,attack:e.volume})},a)}return R(()=>{w.splice(t,1),s.stop().dispose(),o.dispose(),n.dispose()}),e}function K(){let t=[];w.forEach((i,o)=>{let n=512/i.metre.under,s=new h.Track;s.setTempo(v.bpm,0),s.addInstrumentName("piano"),s.addTrackName("Chromatone grid "+o),s.setTimeSignature(4,4,24,8),i.steps.forEach((l,r)=>{l.forEach((a,u)=>{let c=u,b=r,d=n/l.length,k=Object.entries(a).map(m=>m[1]==!0?Number(m[0])+i.tonic:null).filter(m=>Number(m)).map(m=>A(m,"midi").toNote());s.addEvent(new h.NoteEvent({pitch:k,duration:`T${d}`,startTick:n*b+c*d,velocity:i.volume*100}))})}),t[o]=s});var e=new h.Writer(t);B(e.buildFile(),"Chromatone-grid")}export{K as r,G as u};
