import{i as N,r as b,q as T,k as g,K as E}from"./framework.7e747cd7.js";import{t as h}from"./tempo.fceb0f15.js";import{r as S}from"./calculations.3384a913.js";import{g as w}from"./colors.abbc28c6.js";import{F,U as M,l as P,z as C,s as q,X as x,Y as A}from"./index.83aed4fc.js";import{a as D}from"./midi.290fabf9.js";import{b as v,c as O}from"./midiRender.6c0c3f09.js";import{c as R}from"./audio.170dbcbf.js";import{b as n}from"./index.c0ca431c.js";import{S as k}from"./Sequence.a9c1c185.js";import{P as j,M as z}from"./synth.220fb0dd.js";const y=N([]);function J(s=0){const e=N({pitch:b(()=>w.tonic),chroma:b(()=>w.set.chroma),metre:{over:n(`grid-${s}-over`,4),under:n(`grid-${s}-under`,4)},octave:n(`grid-${s}-octave`,3),volume:n(`grid-${s}-vol`,1),pan:n(`grid-${s}-pan`,s%2==1?-.5:.5),probability:n(`grid-${s}-probability`,1),tonic:b(()=>e.pitch+12*e.octave-3),steps:n(`grid-${s}-steps`,[]),current:[],progress:b(()=>h.ticks?t==null?void 0:t.progress:0),clear(){e.steps.forEach((r,o)=>{e.steps[o]=[{}]})},rotate(r=1){e.steps=S(e.steps,r)}});y[s]=e;const{channel:m}=R(`grid-loop-${s}`),i=new M(e.pan,0).connect(m),p=new j().connect(i);p.maxPolyphony=100;let t=new k((r,o)=>{c(o,r)},e.steps,e.metre.under+"n").start(0);T(()=>e.metre.under,()=>{t.stop().dispose(),t=new k((r,o)=>{c(o,r)},e.steps,e.metre.under+"n").start(0),t.probability=e.probability}),T(()=>e.metre.over,()=>{if(e.steps.length>e.metre.over)e.steps.length=e.metre.over;else for(let r=e.steps.length;r<e.metre.over;r++)e.steps.push([{}]);t.events=e.steps},{immediate:!0}),g(()=>{t.events=e.steps}),g(()=>{h.stopped&&(e.current=null)}),g(()=>{t.probability=e.probability,i.volume.targetRampTo(P(e.volume),1),i.pan.targetRampTo(e.pan,1)});function c(r,o){C.state=="suspended"&&q();let u=Object.entries(r).map(a=>{if(a[0]!="sub")return a[1]?z(Number(a[0])+e.tonic):null}).filter(Number);p.triggerAttackRelease(u,{[e.metre.under+"n"]:1/(r.sub||1)},o),x.schedule(()=>{let a=A({[e.metre.under+"n"]:1/(r.sub||1)}).toMilliseconds(),f=u.map(d=>d.toMidi());D(f,{duration:a,attack:e.volume})},o)}return E(()=>{y.splice(s,1),t.stop().dispose(),i.dispose(),p.dispose()}),e}function Q(){let s=[];y.forEach((m,i)=>{let p=512/m.metre.under,t=new v.Track;t.setTempo(h.bpm,0),t.addInstrumentName("piano"),t.addTrackName("Chromatone grid "+i),t.setTimeSignature(4,4),m.steps.forEach((c,r)=>{c.forEach((o,u)=>{let a=u,f=r,d=p/c.length,$=Object.entries(o).map(l=>l[1]==!0?Number(l[0])+m.tonic:null).filter(l=>Number(l)).map(l=>F(l,"midi").toNote());t.addEvent(new v.NoteEvent({pitch:$,duration:`T${d}`,startTick:p*f+a*d,velocity:m.volume*100}))})}),s[i]=t});var e=new v.Writer(s);O(e.buildFile(),"Chromatone-grid")}export{Q as r,J as u};
