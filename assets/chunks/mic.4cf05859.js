import{k as D,v as g,w as n,I as O}from"./framework.adad30f1.js";import{y as b,W as w,o as e,b as S,a as m,r as j,T as r,a0 as d,G as f,s as v,u as _}from"./index.d12b1cdf.js";import{b as y,C as M,c as T}from"./audio.5ebf557e.js";import{U as A}from"./UserMedia.7bc9bd48.js";import{S as C}from"./Subtract.61ab647b.js";import{O as G}from"./OnePoleFilter.33e84b6d.js";class z extends b{constructor(){super(...arguments),this.name="Abs",this._abs=new w({context:this.context,mapping:t=>Math.abs(t)<.001?0:Math.abs(t)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class l extends b{constructor(){super(Object.assign(e(l.getDefaults(),arguments))),this.name="GreaterThanZero",this._thresh=this.output=new w({context:this.context,length:127,mapping:t=>t<=0?0:1}),this._scale=this.input=new S({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class h extends m{constructor(){super(Object.assign(e(h.getDefaults(),arguments,["value"]))),this.name="GreaterThan",this.override=!1;const t=e(h.getDefaults(),arguments,["value"]);this._subtract=this.input=new C({context:this.context,value:t.value}),this._gtz=this.output=new l({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,j(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(m.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class u extends r{constructor(){super(e(u.getDefaults(),arguments,["smoothing"])),this.name="Follower";const t=e(u.getDefaults(),arguments,["smoothing"]);this._abs=this.input=new z({context:this.context}),this._lowpass=this.output=new G({context:this.context,frequency:1/this.toSeconds(t.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=t.smoothing}static getDefaults(){return Object.assign(r.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class c extends r{constructor(){super(Object.assign(e(c.getDefaults(),arguments,["threshold","smoothing"]))),this.name="Gate";const t=e(c.getDefaults(),arguments,["threshold","smoothing"]);this._follower=new u({context:this.context,smoothing:t.smoothing}),this._gt=new h({context:this.context,value:d(t.threshold)}),this.input=new f({context:this.context}),this._gate=this.output=new f({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(r.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return v(this._gt.value)}set threshold(t){this._gt.value=d(t)}get smoothing(){return this._follower.smoothing}set smoothing(t){this._follower.smoothing=t}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}const s=D({initiated:!1,open:!1,opened:!1,recording:!0,monitor:!1,meter:0,volume:_(g("mic-vol",1),0,5),gate:_(g("mic-gate",-60),-100,-40)});let o,i,a,x;function I(){if(!s.initiated){o=new y,o.normalRange=!0,i=new A,x=new M({threshold:-20,ratio:2}).connect(o),a=new c({threshold:-60,smoothing:1}),i.connect(a),a.connect(x);const{channel:p}=T("mic");n(()=>s.open,t=>{t?i.open().then(()=>{s.opened=!0,O(()=>{s.meter=o.getValue()})}):(i.close(),s.opened=!1)}),n(()=>s.monitor,t=>t?o.connect(p):o.disconnect(p)),n(()=>s.volume,t=>i.volume.rampTo(v(t)),{immediate:!0}),n(()=>s.gate,t=>a.threshold=t,{immediate:!0})}return{mic:s,input:i}}export{I as u};
