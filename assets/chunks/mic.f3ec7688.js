import{b as g,i as D}from"./index.2d1b2d4e.js";import{u as m}from"./index.e5aae720.js";import{t as b,W as w,o as e,h as O,j as d,r as S,T as r,Z as f,G as _,l as v}from"./index.83aed4fc.js";import{b as j,C as M,c as T}from"./audio.960b149c.js";import{U as y}from"./UserMedia.4741de0f.js";import{S as A}from"./Subtract.f0fef764.js";import{O as z}from"./OnePoleFilter.2d0525f8.js";import{A as C,z as n}from"./framework.aa37bc02.js";class G extends b{constructor(){super(...arguments),this.name="Abs",this._abs=new w({context:this.context,mapping:t=>Math.abs(t)<.001?0:Math.abs(t)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class l extends b{constructor(){super(Object.assign(e(l.getDefaults(),arguments))),this.name="GreaterThanZero",this._thresh=this.output=new w({context:this.context,length:127,mapping:t=>t<=0?0:1}),this._scale=this.input=new O({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class h extends d{constructor(){super(Object.assign(e(h.getDefaults(),arguments,["value"]))),this.name="GreaterThan",this.override=!1;const t=e(h.getDefaults(),arguments,["value"]);this._subtract=this.input=new A({context:this.context,value:t.value}),this._gtz=this.output=new l({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,S(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(d.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class u extends r{constructor(){super(e(u.getDefaults(),arguments,["smoothing"])),this.name="Follower";const t=e(u.getDefaults(),arguments,["smoothing"]);this._abs=this.input=new G({context:this.context}),this._lowpass=this.output=new z({context:this.context,frequency:1/this.toSeconds(t.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=t.smoothing}static getDefaults(){return Object.assign(r.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class c extends r{constructor(){super(Object.assign(e(c.getDefaults(),arguments,["threshold","smoothing"]))),this.name="Gate";const t=e(c.getDefaults(),arguments,["threshold","smoothing"]);this._follower=new u({context:this.context,smoothing:t.smoothing}),this._gt=new h({context:this.context,value:f(t.threshold)}),this.input=new _({context:this.context}),this._gate=this.output=new _({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(r.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return v(this._gt.value)}set threshold(t){this._gt.value=f(t)}get smoothing(){return this._follower.smoothing}set smoothing(t){this._follower.smoothing=t}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}const s=C({initiated:!1,open:!1,opened:!1,recording:!0,monitor:!1,meter:0,volume:m(g("mic-vol",1),0,2),gate:m(g("mic-gate",-60),-100,-40)});let o,i,a,x;function V(){if(!s.initiated){o=new j,o.normalRange=!0,i=new y,x=new M({threshold:-20,ratio:2}).connect(o),a=new c({threshold:-60,smoothing:1}),i.connect(a),a.connect(x);const{channel:p}=T("mic");n(()=>s.open,t=>{t?i.open().then(()=>{s.opened=!0,D(()=>{s.meter=o.getValue()})}):(i.close(),s.opened=!1)}),n(()=>s.monitor,t=>t?o.connect(p):o.disconnect(p)),n(()=>s.volume,t=>i.volume.rampTo(v(t)),{immediate:!0}),n(()=>s.gate,t=>a.threshold=t,{immediate:!0})}return{mic:s,input:i}}export{V as u};
