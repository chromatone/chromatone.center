import{M as G}from"./Midi.1f918097.js";import{t as j}from"./tempo.5ef17dd6.js";var h={VERSION:"3.0.1",HEADER_CHUNK_TYPE:[77,84,104,100],HEADER_CHUNK_LENGTH:[0,0,0,6],HEADER_CHUNK_FORMAT0:[0,0],HEADER_CHUNK_FORMAT1:[0,1],HEADER_CHUNK_DIVISION:[0,128],TRACK_CHUNK_TYPE:[77,84,114,107],META_EVENT_ID:255,META_SMTPE_OFFSET:84},N=(e,t)=>Array(Math.abs(t)+1).join(e);function q(e){return e!==null&&typeof e=="object"&&typeof e.name=="string"}function z(e){return e!==null&&typeof e=="object"&&typeof e.step=="number"&&typeof e.alt=="number"}var V=[0,2,4,-1,1,3,5],Y=V.map(e=>Math.floor(e*7/12));function $(e){const{step:t,alt:n,oct:i,dir:r=1}=e,a=V[t]+7*n;if(i===void 0)return[r*a];const s=i-Y[t]-4*n;return[r*a,r*s]}var B={empty:!0,name:"",pc:"",acc:""},D=new Map,J=e=>"CDEFGAB".charAt(e),X=e=>e<0?N("b",-e):N("#",e),Z=e=>e[0]==="b"?-e.length:e.length;function x(e){const t=JSON.stringify(e),n=D.get(t);if(n)return n;const i=typeof e=="string"?nt(e):z(e)?x(it(e)):q(e)?x(e.name):B;return D.set(t,i),i}var Q=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function tt(e){const t=Q.exec(e);return[t[1].toUpperCase(),t[2].replace(/x/g,"##"),t[3],t[4]]}var et=(e,t)=>(e%t+t)%t,b=[0,2,4,5,7,9,11];function nt(e){const t=tt(e);if(t[0]===""||t[3]!=="")return B;const n=t[0],i=t[1],r=t[2],a=(n.charCodeAt(0)+3)%7,s=Z(i),c=r.length?+r:void 0,u=$({step:a,alt:s,oct:c}),v=n+i+r,f=n+i,d=(b[a]+s+120)%12,l=c===void 0?et(b[a]+s,12)-12*99:b[a]+s+12*(c+1),E=l>=0&&l<=127?l:null,g=c===void 0?null:Math.pow(2,(l-69)/12)*440;return{empty:!1,acc:i,alt:s,chroma:d,coord:u,freq:g,height:l,letter:n,midi:E,name:v,oct:c,pc:f,step:a}}function it(e){const{step:t,alt:n,oct:i}=e,r=J(t);if(!r)return"";const a=r+X(n);return i||i===0?a+i:a}function rt(e){return+e>=0&&+e<=127}function A(e){if(rt(e))return+e;const t=x(e);return t.empty?null:t.midi}var o=function(){function e(){}return e.version=function(){return h.VERSION},e.stringToBytes=function(t){return t.split("").map(function(n){return n.charCodeAt(0)})},e.isNumeric=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},e.getPitch=function(t,n){return n===void 0&&(n="C4"),60-A(n)+A(t)},e.numberToVariableLength=function(t){t=Math.round(t);for(var n=t&127;t=t>>7;)n<<=8,n|=t&127|128;for(var i=[];i.push(n&255),n&128;)n>>=8;return i},e.stringByteCount=function(t){return encodeURI(t).split(/%..|./).length-1},e.numberFromBytes=function(t){var n="",i;return t.forEach(function(r){i=r.toString(16),i.length==1&&(i="0"+i),n+=i}),parseInt(n,16)},e.numberToBytes=function(t,n){n=n||1;var i=t.toString(16);i.length&1&&(i="0"+i);var r=i.match(/.{2}/g),a=r.map(function(s){return parseInt(s,16)});if(a.length<n)for(;n-a.length>0;)a.unshift(0);return a},e.toArray=function(t){return Array.isArray(t)?t:[t]},e.convertVelocity=function(t){return t=t>100?100:t,Math.round(t/100*127)},e.getTickDuration=function(t){if(Array.isArray(t))return t.map(function(a){return e.getTickDuration(a)}).reduce(function(a,s){return a+s},0);if(t=t.toString(),t.toLowerCase().charAt(0)==="t"){var n=parseInt(t.substring(1));if(isNaN(n)||n<0)throw new Error(t+" is not a valid duration.");return n}var i=e.numberFromBytes(h.HEADER_CHUNK_DIVISION),r=i*e.getDurationMultiplier(t);return e.getRoundedIfClose(r)},e.getRoundedIfClose=function(t){var n=Math.round(t);return Math.abs(n-t)<1e-6?n:t},e.getPrecisionLoss=function(t){var n=Math.round(t);return n-t},e.getDurationMultiplier=function(t){if(t==="0")return 0;var n=t.match(/^(?<dotted>d+)?(?<base>\d+)(?:t(?<tuplet>\d*))?/);if(n){var i=Number(n.groups.base),r=i===1||(i&i-1)===0;if(r){var a=i/4,s=1/a,c=n.groups,u=c.dotted,v=c.tuplet;if(u){var f=u.length,d=Math.pow(2,f);s=s+s*((d-1)/d)}if(typeof v=="string"){var l=s*2,E=Number(v||"3");s=l/E}return s}}throw new Error(t+" is not a valid duration.")},e}(),M=function(){function e(t){this.channel=t.channel-1||0,this.controllerValue=t.controllerValue,this.controllerNumber=t.controllerNumber,this.delta=t.delta||0,this.name="ControllerChangeEvent",this.status=176,this.data=o.numberToVariableLength(t.delta).concat(this.status|this.channel,this.controllerNumber,this.controllerValue)}return e}(),I=function(){function e(t){this.delta=t.delta||0,this.name="CopyrightEvent",this.text=t.text,this.type=2;var n=o.stringToBytes(this.text);this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type,o.numberToVariableLength(n.length),n)}return e}(),L=function(){function e(t){this.delta=t.delta||0,this.name="CuePointEvent",this.text=t.text,this.type=7;var n=o.stringToBytes(this.text);this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type,o.numberToVariableLength(n.length),n)}return e}(),k=function(){function e(t){this.delta=(t==null?void 0:t.delta)||0,this.name="EndTrackEvent",this.type=[47,0],this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type)}return e}(),P=function(){function e(t){this.delta=t.delta||0,this.name="InstrumentNameEvent",this.text=t.text,this.type=4;var n=o.stringToBytes(this.text);this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type,o.numberToVariableLength(n.length),n)}return e}(),S=function(){function e(t,n){this.name="KeySignatureEvent",this.type=89;var i=n||0;if(t=t||0,typeof n>"u"){var r=[["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"],["ab","eb","bb","f","c","g","d","a","e","b","f#","c#","g#","d#","a#"]],a=t.length,s=t||"C";if(t[0]===t[0].toLowerCase()&&(i=1),a>1)switch(t.charAt(a-1)){case"m":i=1,s=t.charAt(0).toLowerCase(),s=s.concat(t.substring(1,a-1));break;case"-":i=1,s=t.charAt(0).toLowerCase(),s=s.concat(t.substring(1,a-1));break;case"M":i=0,s=t.charAt(0).toUpperCase(),s=s.concat(t.substring(1,a-1));break;case"+":i=0,s=t.charAt(0).toUpperCase(),s=s.concat(t.substring(1,a-1));break}var c=r[i].indexOf(s);t=c===-1?0:c-7}this.data=o.numberToVariableLength(0).concat(h.META_EVENT_ID,this.type,[2],o.numberToBytes(t,1),o.numberToBytes(i,1))}return e}(),R=function(){function e(t){this.delta=t.delta||0,this.name="LyricEvent",this.text=t.text,this.type=5;var n=o.stringToBytes(this.text);this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type,o.numberToVariableLength(n.length),n)}return e}(),F=function(){function e(t){this.delta=t.delta||0,this.name="MarkerEvent",this.text=t.text,this.type=6;var n=o.stringToBytes(this.text);this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type,o.numberToVariableLength(n.length),n)}return e}(),p=function(){function e(t){this.name="NoteOnEvent",this.channel=t.channel||1,this.pitch=t.pitch,this.wait=t.wait||0,this.velocity=t.velocity||50,this.tick=t.tick||null,this.delta=null,this.data=t.data,this.status=144}return e.prototype.buildData=function(t,n,i){return i===void 0&&(i={}),this.data=[],this.tick?(this.tick=o.getRoundedIfClose(this.tick),t.tickPointer==0&&(this.delta=this.tick)):(this.delta=o.getTickDuration(this.wait),this.tick=o.getRoundedIfClose(t.tickPointer+this.delta)),this.deltaWithPrecisionCorrection=o.getRoundedIfClose(this.delta-n),this.data=o.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,o.getPitch(this.pitch,i.middleC),o.convertVelocity(this.velocity)),this},e}(),m=function(){function e(t){this.name="NoteOffEvent",this.channel=t.channel||1,this.pitch=t.pitch,this.velocity=t.velocity||50,this.tick=t.tick||null,this.data=t.data,this.delta=t.delta||o.getTickDuration(t.duration),this.status=128}return e.prototype.buildData=function(t,n,i){return i===void 0&&(i={}),this.tick===null&&(this.tick=o.getRoundedIfClose(this.delta+t.tickPointer)),this.deltaWithPrecisionCorrection=o.getRoundedIfClose(this.delta-n),this.data=o.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,o.getPitch(this.pitch,i.middleC),o.convertVelocity(this.velocity)),this},e}(),y=function(){function e(t){this.data=[],this.name="NoteEvent",this.pitch=o.toArray(t.pitch),this.channel=t.channel||1,this.duration=t.duration||"4",this.grace=t.grace,this.repeat=t.repeat||1,this.sequential=t.sequential||!1,this.tick=t.startTick||t.tick||null,this.velocity=t.velocity||50,this.wait=t.wait||0,this.tickDuration=o.getTickDuration(this.duration),this.restDuration=o.getTickDuration(this.wait),this.events=[]}return e.prototype.buildData=function(){var t=this;if(this.data=[],this.grace){var n=1;this.grace=o.toArray(this.grace),this.grace.forEach(function(){var r=new e({pitch:t.grace,duration:"T"+n});t.data=t.data.concat(r.data)})}if(this.sequential)for(var i=0;i<this.repeat;i++)this.pitch.forEach(function(a,s){var c=new p({channel:t.channel,wait:s>0?0:t.wait,delta:s>0?0:o.getTickDuration(t.wait),velocity:t.velocity,pitch:a,tick:t.tick}),u=new m({channel:t.channel,duration:t.duration,velocity:t.velocity,pitch:a});t.events.push(c,u)});else for(var i=0;i<this.repeat;i++)this.pitch.forEach(function(r,a){var s;a==0?s=new p({channel:t.channel,wait:t.wait,delta:o.getTickDuration(t.wait),velocity:t.velocity,pitch:r,tick:t.tick}):s=new p({channel:t.channel,wait:0,delta:0,velocity:t.velocity,pitch:r,tick:t.tick}),t.events.push(s)}),this.pitch.forEach(function(r,a){var s;a==0?s=new m({channel:t.channel,duration:t.duration,velocity:t.velocity,pitch:r,tick:t.tick!==null?o.getTickDuration(t.duration)+t.tick:null}):s=new m({channel:t.channel,duration:0,velocity:t.velocity,pitch:r,tick:t.tick!==null?o.getTickDuration(t.duration)+t.tick:null}),t.events.push(s)});return this},e}(),O=function(){function e(t){this.channel=t.channel||0,this.delta=t.delta||0,this.name="PitchBendEvent",this.status=224;var n=this.scale14bits(t.bend),i=n&127,r=n>>7&127;this.data=o.numberToVariableLength(this.delta).concat(this.status|this.channel,i,r)}return e.prototype.scale14bits=function(t){return t<=0?Math.floor(16384*(t+1)/2):Math.floor(16383*(t+1)/2)},e}(),at=function(){function e(t){this.channel=t.channel||0,this.delta=t.delta||0,this.instrument=t.instrument,this.status=192,this.name="ProgramChangeEvent",this.data=o.numberToVariableLength(this.delta).concat(this.status|this.channel,this.instrument)}return e}(),C=function(){function e(t){this.bpm=t.bpm,this.delta=t.delta||0,this.tick=t.tick,this.name="TempoEvent",this.type=81;var n=Math.round(6e7/this.bpm);this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type,[3],o.numberToBytes(n,3))}return e}(),H=function(){function e(t){this.delta=t.delta||0,this.text=t.text,this.name="TextEvent",this.type=1;var n=o.stringToBytes(this.text);this.data=o.numberToVariableLength(t.delta).concat(h.META_EVENT_ID,this.type,o.numberToVariableLength(n.length),n)}return e}(),U=function(){function e(t,n,i,r){this.name="TimeSignatureEvent",this.type=88,this.data=o.numberToVariableLength(0).concat(h.META_EVENT_ID,this.type,[4],o.numberToBytes(t,1),o.numberToBytes(Math.log2(n),1),o.numberToBytes(i||24,1),o.numberToBytes(r||8,1))}return e}(),K=function(){function e(t){this.delta=t.delta||0,this.name="TrackNameEvent",this.text=t.text,this.type=3;var n=o.stringToBytes(this.text);this.data=o.numberToVariableLength(this.delta).concat(h.META_EVENT_ID,this.type,o.numberToVariableLength(n.length),n)}return e}(),W=function(){function e(){this.type=h.TRACK_CHUNK_TYPE,this.data=[],this.size=[],this.events=[],this.explicitTickEvents=[],this.tickPointer=0}return e.prototype.addEvent=function(t,n){var i=this;return o.toArray(t).forEach(function(r,a){if(r instanceof y){if(typeof n=="function"){var s=n(a,r);typeof s=="object"&&Object.assign(r,s)}r.tick!==null?i.explicitTickEvents.push(r):r.buildData().events.forEach(function(c){return i.events.push(c)})}else i.events.push(r)}),this},e.prototype.buildData=function(t){var n=this;t===void 0&&(t={}),this.data=[],this.size=[],this.tickPointer=0;var i=0;return this.events.forEach(function(r){if(r instanceof p||r instanceof m){var a=r.buildData(n,i,t);i=o.getPrecisionLoss(r.deltaWithPrecisionCorrection||0),n.data=n.data.concat(a.data),n.tickPointer=o.getRoundedIfClose(r.tick)}else r instanceof C&&(n.tickPointer=o.getRoundedIfClose(r.tick)),n.data=n.data.concat(r.data)}),this.mergeExplicitTickEvents(),(!this.events.length||!(this.events[this.events.length-1]instanceof k))&&(this.data=this.data.concat(new k().data)),this.size=o.numberToBytes(this.data.length,4),this},e.prototype.mergeExplicitTickEvents=function(){var t=this;this.explicitTickEvents.length&&(this.explicitTickEvents.sort(function(n,i){return n.tick-i.tick}),this.explicitTickEvents.forEach(function(n){n.buildData().events.forEach(function(i){return i.buildData(t)}),n.events.forEach(function(i){return t.mergeSingleEvent(i)})}),this.explicitTickEvents=[],this.buildData())},e.prototype.mergeTrack=function(t){var n=this;return this.buildData(),t.buildData().events.forEach(function(i){return n.mergeSingleEvent(i)}),this},e.prototype.mergeSingleEvent=function(t){if(!this.events.length){this.addEvent(t);return}for(var n,i=0;i<this.events.length&&!(this.events[i].tick>t.tick);i++)n=i;var r=n+1;t.delta=t.tick-this.events[n].tick,this.events.splice(r,0,t);for(var i=r+1;i<this.events.length;i++)this.events[i].delta=this.events[i].tick-this.events[i-1].tick},e.prototype.removeEventsByName=function(t){var n=this;return this.events.forEach(function(i,r){i.name===t&&n.events.splice(r,1)}),this},e.prototype.setTempo=function(t,n){return n===void 0&&(n=0),this.addEvent(new C({bpm:t,tick:n}))},e.prototype.setTimeSignature=function(t,n,i,r){return this.addEvent(new U(t,n,i,r))},e.prototype.setKeySignature=function(t,n){return this.addEvent(new S(t,n))},e.prototype.addText=function(t){return this.addEvent(new H({text:t}))},e.prototype.addCopyright=function(t){return this.addEvent(new I({text:t}))},e.prototype.addTrackName=function(t){return this.addEvent(new K({text:t}))},e.prototype.addInstrumentName=function(t){return this.addEvent(new P({text:t}))},e.prototype.addMarker=function(t){return this.addEvent(new F({text:t}))},e.prototype.addCuePoint=function(t){return this.addEvent(new L({text:t}))},e.prototype.addLyric=function(t){return this.addEvent(new R({text:t}))},e.prototype.polyModeOn=function(){var t=new p({data:[0,176,126,0]});return this.addEvent(t)},e.prototype.setPitchBend=function(t){return this.addEvent(new O({bend:t}))},e.prototype.controllerChange=function(t,n,i,r){return this.addEvent(new M({controllerNumber:t,controllerValue:n,channel:i,delta:r}))},e}(),ot=function(){function e(){}return e.prototype.trackFromVoice=function(t,n){var i=this;n===void 0&&(n={addRenderedAccidentals:!1});var r=new W,a=[];return t.tickables.forEach(function(s){s.noteType==="n"?(r.addEvent(new y({pitch:s.keys.map(function(c,u){return i.convertPitch(c,u,s,n.addRenderedAccidentals)}),duration:i.convertDuration(s),wait:a})),a=[]):s.noteType==="r"&&a.push(i.convertDuration(s))}),a.length>0&&r.addEvent(new y({pitch:"[c4]",duration:"0",wait:a,velocity:"0"})),r},e.prototype.convertPitch=function(t,n,i,r){var a;r===void 0&&(r=!1);var s=t.split("/"),c=s[0].substring(1).replace("n","");return r&&((a=i.getAccidentals())===null||a===void 0||a.forEach(function(u){u.index===n&&(u.type==="n"?c="":c+=u.type)})),s[0][0]+c+s[1]},e.prototype.convertDuration=function(t){return"d".repeat(t.dots)+this.convertBaseDuration(t.duration)+(t.tuplet?"t"+t.tuplet.num_notes:"")},e.prototype.convertBaseDuration=function(t){switch(t){case"w":return"1";case"h":return"2";case"q":return"4";default:return t}},e}(),st=function(){function e(t){this.type=h.HEADER_CHUNK_TYPE;var n=t>1?h.HEADER_CHUNK_FORMAT1:h.HEADER_CHUNK_FORMAT0;this.data=n.concat(o.numberToBytes(t,2),h.HEADER_CHUNK_DIVISION),this.size=[0,0,0,this.data.length]}return e}(),ct=function(){function e(t,n){n===void 0&&(n={}),this.tracks=o.toArray(t),this.options=n}return e.prototype.buildData=function(){var t=this,n=[];return n.push(new st(this.tracks.length)),this.tracks.forEach(function(i){n.push(i.buildData(t.options))}),n},e.prototype.buildFile=function(){var t=[];return this.buildData().forEach(function(n){return t=t.concat(n.type,n.size,n.data)}),new Uint8Array(t)},e.prototype.base64=function(){return typeof btoa=="function"?btoa(String.fromCharCode.apply(null,this.buildFile())):Buffer.from(this.buildFile()).toString("base64")},e.prototype.dataUri=function(){return"data:audio/midi;base64,"+this.base64()},e.prototype.setOption=function(t,n){return this.options[t]=n,this},e.prototype.stdout=function(){return process.stdout.write(Buffer.from(this.buildFile()))},e}(),ht={Constants:h,ControllerChangeEvent:M,CopyrightEvent:I,CuePointEvent:L,EndTrackEvent:k,InstrumentNameEvent:P,KeySignatureEvent:S,LyricEvent:R,MarkerEvent:F,NoteOnEvent:p,NoteOffEvent:m,NoteEvent:y,PitchBendEvent:O,ProgramChangeEvent:at,TempoEvent:C,TextEvent:H,TimeSignatureEvent:U,Track:W,TrackNameEvent:K,Utils:o,VexFlow:ot,Writer:ct},T=ht;let _=["C","E","G","B","D","F","A","C#","D#","F#","G#","A#"];function dt(e){let t=[];console.log(e),e.forEach((r,a)=>{var u;let s=512/((u=r==null?void 0:r.meter)==null?void 0:u.under),c=new T.Track;c.setTempo(j.bpm,0),c.addInstrumentName("116"),c.addTrackName("Chromatone beat "+a),c.setTimeSignature(4,4),r.steps.forEach((v,f)=>{v.forEach(d=>{if(r.mutes[f]||r.mutes[d])return;let[l,E]=d.split("-").map(Number),g=s/v.length,w=0;v.length>1&&(w=E*g),c.addEvent(new T.NoteEvent({pitch:r.accents[f]?_[a*2]+"2":_[a*2+1]+"2",duration:`T${g}`,startTick:s*l+w,velocity:r.accents[f]||r.accents[d]?100:64}))})}),t[a]=c});var n=new T.Writer(t);let i=new G.Midi(n.buildFile());i.tracks.forEach((r,a)=>{i.tracks[a].instrument.number=119}),ut(i.toArray(),"Chromatone-beat")}function ut(e,t,n="mid"){const i=new Blob([e]),r=`${t}.${n}`;if(navigator.msSaveBlob)navigator.msSaveBlob(i,r);else{const a=document.createElement("a");if(a.download!==void 0){const s=URL.createObjectURL(i);a.setAttribute("href",s),a.setAttribute("download",r),a.setAttribute("target","_blank"),a.style.visibility="hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)}}}export{T as b,ut as c,dt as r};
