import{g as P,a as C,f as p,m as U,I as S,o as d,b as r,i as I,S as N,M as F,w as j,c as b,d as z,e as G,T as q,h,G as A,j as Q,r as K,k as L,l as B,s as H}from"./index.83aed4fc.js";import{m as T}from"./midi.10bf3c51.js";import{b as V,d as J,o as X}from"./index.7c47e578.js";import{S as Y,M as Z,E as $,c as tt,R as et,C as st}from"./audio.998c0aad.js";import{u as it}from"./index.0511e153.js";import{A as O}from"./Scale.7b617051.js";import{S as x}from"./Subtract.f0fef764.js";import{P as nt}from"./PingPongDelay.6f99311a.js";import{A as ot}from"./AutoPanner.bc217bb3.js";import{M as ct}from"./MonoSynth.4cac63d2.js";import{A as R,z as m}from"./framework.fee3f2bd.js";class l extends C{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(t){return p(super._frequencyToUnits(t))}_ticksToUnits(t){return p(super._ticksToUnits(t))}_beatsToUnits(t){return p(super._beatsToUnits(t))}_secondsToUnits(t){return p(super._secondsToUnits(t))}toMidi(){return this.valueOf()}toFrequency(){return U(this.toMidi())}transpose(t){return new l(this.context,this.toMidi()+t)}}function E(n,t){return new l(P(),n,t)}class _ extends S{constructor(){super(d(_.getDefaults(),arguments,["voice","options"])),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=o=>this.releaseAll(o);const t=d(_.getDefaults(),arguments,["voice","options"]);r(!I(t.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const s=t.voice.getDefaults();this.options=Object.assign(s,t.options),this.voice=t.voice,this.maxPolyphony=t.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const i=this._voices.indexOf(this._dummyVoice);this._voices.splice(i,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(S.getDefaults(),{maxPolyphony:32,options:{},voice:N})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(t){this._availableVoices.push(t);const s=this._activeVoices.findIndex(i=>i.voice===t);this._activeVoices.splice(s,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const t=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return r(t instanceof F,"Voice must extend Monophonic class"),t.connect(this.output),this._voices.push(t),t}else j("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(this._averageActiveVoices*.95,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const t=this._availableVoices.shift(),s=this._voices.indexOf(t);this._voices.splice(s,1),this.context.isOffline||t.dispose()}}_triggerAttack(t,s,i){t.forEach(o=>{const a=new l(this.context,o).toMidi(),c=this._getNextAvailableVoice();c&&(c.triggerAttack(o,s,i),this._activeVoices.push({midi:a,voice:c,released:!1}),this.log("triggerAttack",o,s))})}_triggerRelease(t,s){t.forEach(i=>{const o=new l(this.context,i).toMidi(),a=this._activeVoices.find(({midi:c,released:f})=>c===o&&!f);a&&(a.voice.triggerRelease(s),a.released=!0,this.log("triggerRelease",i,s))})}_scheduleEvent(t,s,i,o){r(!this.disposed,"Synth was already disposed"),i<=this.now()?t==="attack"?this._triggerAttack(s,i,o):this._triggerRelease(s,i):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(t,s,i,o)},i-this.now())}triggerAttack(t,s,i){Array.isArray(t)||(t=[t]);const o=this.toSeconds(s);return this._scheduleEvent("attack",t,o,i),this}triggerRelease(t,s){Array.isArray(t)||(t=[t]);const i=this.toSeconds(s);return this._scheduleEvent("release",t,i),this}triggerAttackRelease(t,s,i,o){const a=this.toSeconds(i);if(this.triggerAttack(t,a,o),b(s)){r(b(t),"If the duration is an array, the notes must also be an array"),t=t;for(let c=0;c<t.length;c++){const f=s[Math.min(c,s.length-1)],w=this.toSeconds(f);r(w>0,"The duration must be greater than 0"),this.triggerRelease(t[c],a+w)}}else{const c=this.toSeconds(s);r(c>0,"The duration must be greater than 0"),this.triggerRelease(t,a+c)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(t){const s=z(t,["onsilence","context"]);return this.options=G(this.options,s),this._voices.forEach(i=>i.set(s)),this._dummyVoice.set(s),this}get(){return this._dummyVoice.get()}releaseAll(t){const s=this.toSeconds(t);return this._activeVoices.forEach(({voice:i})=>{i.triggerRelease(s)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(t=>t.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class y extends q{constructor(){super(d(y.getDefaults(),arguments)),this.name="MidSideSplit",this._split=this.input=new Y({channels:2,context:this.context}),this._midAdd=new O({context:this.context}),this.mid=new h({context:this.context,value:Math.SQRT1_2}),this._sideSubtract=new x({context:this.context}),this.side=new h({context:this.context,value:Math.SQRT1_2}),this._split.connect(this._midAdd,0),this._split.connect(this._midAdd.addend,1),this._split.connect(this._sideSubtract,0),this._split.connect(this._sideSubtract.subtrahend,1),this._midAdd.connect(this.mid),this._sideSubtract.connect(this.side)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midAdd.dispose(),this._sideSubtract.dispose(),this._split.dispose(),this}}class M extends q{constructor(){super(d(M.getDefaults(),arguments)),this.name="MidSideMerge",this.mid=new A({context:this.context}),this.side=new A({context:this.context}),this._left=new O({context:this.context}),this._leftMult=new h({context:this.context,value:Math.SQRT1_2}),this._right=new x({context:this.context}),this._rightMult=new h({context:this.context,value:Math.SQRT1_2}),this._merge=this.output=new Z({context:this.context}),this.mid.fan(this._left),this.side.connect(this._left.addend),this.mid.connect(this._right),this.side.connect(this._right.subtrahend),this._left.connect(this._leftMult),this._right.connect(this._rightMult),this._leftMult.connect(this._merge,0,0),this._rightMult.connect(this._merge,0,1)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._leftMult.dispose(),this._rightMult.dispose(),this._left.dispose(),this._right.dispose(),this}}class k extends ${constructor(t){super(t),this.name="MidSideEffect",this._midSideMerge=new M({context:this.context}),this._midSideSplit=new y({context:this.context}),this._midSend=this._midSideSplit.mid,this._sideSend=this._midSideSplit.side,this._midReturn=this._midSideMerge.mid,this._sideReturn=this._midSideMerge.side,this.effectSend.connect(this._midSideSplit),this._midSideMerge.connect(this.effectReturn)}connectEffectMid(...t){this._midSend.chain(...t,this._midReturn)}connectEffectSide(...t){this._sideSend.chain(...t,this._sideReturn)}dispose(){return super.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this._midSend.dispose(),this._sideSend.dispose(),this._midReturn.dispose(),this._sideReturn.dispose(),this}}class g extends k{constructor(){super(d(g.getDefaults(),arguments,["width"])),this.name="StereoWidener";const t=d(g.getDefaults(),arguments,["width"]);this.width=new Q({context:this.context,value:t.width,units:"normalRange"}),K(this,["width"]),this._twoTimesWidthMid=new h({context:this.context,value:2}),this._twoTimesWidthSide=new h({context:this.context,value:2}),this._midMult=new h({context:this.context}),this._twoTimesWidthMid.connect(this._midMult.factor),this.connectEffectMid(this._midMult),this._oneMinusWidth=new x({context:this.context}),this._oneMinusWidth.connect(this._twoTimesWidthMid),L(this.context.getConstant(1),this._oneMinusWidth),this.width.connect(this._oneMinusWidth.subtrahend),this._sideMult=new h({context:this.context}),this.width.connect(this._twoTimesWidthSide),this._twoTimesWidthSide.connect(this._sideMult.factor),this.connectEffectSide(this._sideMult)}static getDefaults(){return Object.assign(k.getDefaults(),{width:.5})}dispose(){return super.dispose(),this.width.dispose(),this._midMult.dispose(),this._sideMult.dispose(),this._twoTimesWidthMid.dispose(),this._twoTimesWidthSide.dispose(),this._oneMinusWidth.dispose(),this}}const at=["+0","@8n","@16n","@32n"],e={state:R({midi:V("synth-midi",!0),initiated:!1,mute:!1,quantize:J(at,{initialValue:"+0"}),volume:it(1,0,2)}),params:R({maxPolyphony:50,oscillator:{type:V("synth-osc","sawtooth8")},volume:-30,envelope:{attack:.01,decay:.1,sustain:.6,release:1},filterEnvelope:{attack:.001,decay:.7,sustain:.5,release:1,baseFrequency:60,octaves:5}}),poly:null,widener:null,delay:null,reverb:null,pan:null,compressor:null};function yt(){return e.state.initiated||(X("Escape",()=>{v()}),m(()=>e.state.volume,n=>e.poly&&e.poly.volume.rampTo(B(n))),m(e.params,n=>{e.poly&&e.poly.set(n)},{deep:!0,immediate:!0}),m(()=>T.note,n=>{var t;(t=e==null?void 0:e.state)!=null&&t.midi&&(n.velocity>0?D(E(n.number).toFrequency(),n.velocity/127):W(E(n.number).toFrequency()))}),m(()=>T.playing,n=>{n||v()})),{init:u,synth:e,once:ht,attack:D,release:W,releaseAll:v}}function u(){if(H(),e!=null&&e.poly)return;const{channel:n}=tt("synth");e.widener=new g(.7).connect(n),e.reverb=new et(3).connect(e.widener),e.delay=new nt({delayTime:"16n",feedback:.3,wet:.3,maxDelay:"4n"}).connect(e.widener),e.pan=new ot({frequency:"4n",depth:.4}).connect(e.reverb).connect(e.delay).connect(e.widener),e.compressor=new st().connect(e.pan),e.poly=new _(ct,e.params).connect(e.compressor),e.pan.start()}function ht(n,t="16n",s){if(!e.poly||e.state.mute)return u();console.log(n,t),e.poly.triggerAttackRelease(n||"A4",t,s)}function D(n,t){if(!e.poly||e.state.mute)return u();e.poly.triggerAttack(n,e.state.quantize.state,t)}function W(n){if(!e.poly||e.state.mute)return u();e.poly.triggerRelease(n,e.state.quantize.state)}function v(){if(!e.poly||e.state.mute)return u();e.poly.releaseAll()}export{E as M,_ as P,W as a,ht as b,e as c,D as s,yt as u};
