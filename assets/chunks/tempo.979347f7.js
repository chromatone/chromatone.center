import{F as c,$ as v,X as f,a0 as l,l as T,s as w}from"./index.83aed4fc.js";import{b as E}from"./calculations.65ee336d.js";import{n as C}from"./colors.027ae8bf.js";import"./index.b30cd6d2.js";import{n as d}from"./index.6b4e0cd9.js";import{b as r,c as z,l as g,m as S}from"./index.abf15ce3.js";import{c as A}from"./audio.85cd45c5.js";import{u as h}from"./index.e5c73bca.js";import{w as N,m}from"./midi.546d3551.js";import{L as b}from"./Loop.b192c9c2.js";import{A as k,i as s,Q as D,j as F,z as n}from"./framework.11beae03.js";const e=k({initialized:!1,bpm:h(r("tempo-bpm",100),10,500),clock:null,midiClock:r("midi-clock-out",!1),tabSync:r("tab-sync",!1),blink:!1,started:!1,playing:!1,stopped:!1,mute:r("tempo-mute",!0),volume:h(r("tempo-volume",.5),0,1),progress:0,position:null,ticks:0,metre:{over:4,under:4,num:s(()=>(e.metre.over/(e.metre.under/4)).toFixed(2))},hz:s(()=>(e.bpm/60).toFixed(2)),note:s(()=>d.pitchClass(c(e.hz).toNote())),tune:s(()=>d.pitchClass(e.note)+4),pitch:s(()=>E(Number(e.hz))),digit:s(()=>(c(e.hz).toMidi()+12*10+3)%12),color:s(()=>C(e.digit)),tap:{last:0,diff:0,timeout:2e3,times:[],bpm:null,tap:R},set(a){e.bpm=Math.round(a+e.bpm)}});function $(){if(e.initialized)return e;const a=D({counter:0,pluck:null,channel:null,clock:null,loop:null});F(()=>{const{channel:t}=A("tempo-tick");a.channel=t,a.pluck=new v({urls:{E1:"/logic/high.wav",E2:"/logic/low.wav"},volume:-20,attack:.001,release:2,baseUrl:"/audio/metronome/"}).connect(t),a.clock=new b(o=>{e.midiClock&&f.schedule(()=>{N.outputs.forEach(i=>i.sendClock())},o)},"8i").start(0),a.loop=new b(o=>{let i=a.counter%2==0;i&&f.schedule(()=>{e.blink=!0,setTimeout(()=>{e.blink=!1},60)},o),e.mute||a.pluck.triggerAttackRelease(i?"E1":"E2","16n",o,i?1:.2),a.counter++},"8n").start(0),z(()=>{e.position=l.position,e.ticks=l.ticks,e.progress=a.loop.progress}),g(" ",o=>{const i=o.target;["TEXTAREA","INPUT"].includes(i.nodeName)||(o.preventDefault(),e.playing=!e.playing)}),g("Enter",o=>{const i=o.target;["TEXTAREA","INPUT"].includes(i.nodeName)||(o.preventDefault(),e.stopped=Date.now())})}),k({playing:!1,stopped:!1});const{data:u,post:p}=S({name:"chromatone-tempo"});return n(u,t=>{e.tabSync&&(e.playing=!!(t!=null&&t.playing),e.stopped=!!(t!=null&&t.stopped))}),n(()=>e.volume,t=>a.pluck.volume.rampTo(T(t))),n(()=>e.bpm,t=>l.bpm.rampTo(t,"4n"),{immediate:!0}),n(()=>e.stopped,t=>{t&&(l.stop(),m.stopAll(),e.playing=!1,e.tabSync&&p({stopped:t}))}),n(()=>e.playing,t=>{t?(e.started||(w(),e.started=!0),e.stopped=!1,l.start(),m.playing=!0,e.tabSync&&p({playing:!0})):(m.playing=!1,l.pause(),e.tabSync&&p({playing:!1}))},{immediate:!0}),n(()=>m.playing,t=>e.playing=t),n(()=>m.stopped,t=>e.stopped=t),e.initialized=!0,e}function R(){var a=performance.now();e.tap.last&&(e.tap.diff=a-e.tap.last,e.tap.times.push(e.tap.diff),x()),e.tap.last=a,M()}function x(){if(e.tap.times.length>2){var a=e.tap.times.reduce((p,t)=>p+=t)/e.tap.times.length,u=1/(a/1e3)*60;e.tap.bpm=u}}let y=null;function M(){clearTimeout(y),y=setTimeout(function(){e.tap.times=[e.tap.diff],e.tap.last=null},e.tap.timeout)}export{R as a,e as t,$ as u};
