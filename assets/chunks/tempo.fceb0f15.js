import{i as y,r as s,l as T,e as v,q as n}from"./framework.7e747cd7.js";import{F as c,$ as w,X as f,a0 as l,l as E,s as C}from"./index.83aed4fc.js";import{f as S}from"./calculations.3384a913.js";import{n as z}from"./colors.abbc28c6.js";import"./index.b30cd6d2.js";import{n as d}from"./index.b77db23e.js";import{b as p,i as A,j as g,k as N}from"./index.c0ca431c.js";import{c as D}from"./audio.170dbcbf.js";import{u as h}from"./index.0b97d2b2.js";import{w as F,m}from"./midi.290fabf9.js";import{L as b}from"./Loop.b192c9c2.js";const t=y({initialized:!1,bpm:h(p("tempo-bpm",100),10,500),clock:null,midiClock:p("midi-clock-out",!1),tabSync:p("tab-sync",!1),blink:!1,started:!1,playing:!1,stopped:!1,mute:p("tempo-mute",!0),volume:h(p("tempo-volume",.5),0,1),progress:0,position:null,ticks:0,metre:{over:4,under:4,num:s(()=>(t.metre.over/(t.metre.under/4)).toFixed(2))},hz:s(()=>(t.bpm/60).toFixed(2)),note:s(()=>d.pitchClass(c(t.hz).toNote())),tune:s(()=>d.pitchClass(t.note)+4),pitch:s(()=>S(Number(t.hz))),digit:s(()=>(c(t.hz).toMidi()+12*10+3)%12),color:s(()=>z(t.digit)),tap:{last:0,diff:0,timeout:2e3,times:[],bpm:null,tap:q},set(a){t.bpm=Math.round(a+t.bpm)}});function G(){if(t.initialized)return t;const a=T({counter:0,pluck:null,channel:null,clock:null,loop:null});v(()=>{const{channel:e}=D("tempo-tick");a.channel=e,a.pluck=new w({urls:{E1:"/logic/high.wav",E2:"/logic/low.wav"},volume:-20,attack:.001,release:2,baseUrl:"/audio/metronome/"}).connect(e),a.clock=new b(o=>{t.midiClock&&f.schedule(()=>{F.outputs.forEach(i=>i.sendClock())},o)},"8i").start(0),a.loop=new b(o=>{let i=a.counter%2==0;i&&f.schedule(()=>{t.blink=!0,setTimeout(()=>{t.blink=!1},60)},o),t.mute||a.pluck.triggerAttackRelease(i?"E1":"E2","16n",o,i?1:.2),a.counter++},"8n").start(0),A(()=>{t.position=l.position,t.ticks=l.ticks,t.progress=a.loop.progress}),g(" ",o=>{const i=o.target;["TEXTAREA","INPUT"].includes(i.nodeName)||(o.preventDefault(),t.playing=!t.playing)}),g("Enter",o=>{const i=o.target;["TEXTAREA","INPUT"].includes(i.nodeName)||(o.preventDefault(),t.stopped=Date.now())})}),y({playing:!1,stopped:!1});const{data:u,post:r}=N({name:"chromatone-tempo"});return n(u,e=>{t.tabSync&&(t.playing=!!(e!=null&&e.playing),t.stopped=!!(e!=null&&e.stopped))}),n(()=>t.volume,e=>a.pluck.volume.rampTo(E(e))),n(()=>t.bpm,e=>l.bpm.rampTo(e,"4n"),{immediate:!0}),n(()=>t.stopped,e=>{e&&(l.stop(),m.stopAll(),t.playing=!1,t.tabSync&&r({stopped:e}))}),n(()=>t.playing,e=>{e?(t.started||(C(),t.started=!0),t.stopped=!1,l.start(),m.playing=!0,t.tabSync&&r({playing:!0})):(m.playing=!1,l.pause(),t.tabSync&&r({playing:!1}))},{immediate:!0}),n(()=>m.playing,e=>t.playing=e),n(()=>m.stopped,e=>t.stopped=e),t.initialized=!0,t}function q(){var a=performance.now();t.tap.last&&(t.tap.diff=a-t.tap.last,t.tap.times.push(t.tap.diff),R()),t.tap.last=a,x()}function R(){if(t.tap.times.length>2){var a=t.tap.times.reduce((r,e)=>r+=e)/t.tap.times.length,u=1/(a/1e3)*60;t.tap.bpm=u}}let k=null;function x(){clearTimeout(k),k=setTimeout(function(){t.tap.times=[t.tap.diff],t.tap.last=null},t.tap.timeout)}export{q as a,t,G as u};
