import{ar as n,as as w}from"./theme.ClagsQLu.js";import{s as b,b as l,p as y,o as h,d as C,m as r}from"./framework.BR0mAPCP.js";const t=b({initiating:!1,initiated:!1,started:!1,running:!1,ctx:null,core:null,node:null,layers:{}}),f=l({}),p=l({}),x=l({});function k(){return y()&&h(()=>{o()}),C(()=>t.layers,()=>{t.initiated&&d()}),{audio:t,initAudio:o,render:d,meters:f,scopes:p,FFTs:x}}function d(){var u,c,m;if(t.initiated||o(),((u=t==null?void 0:t.ctx)==null?void 0:u.state)==="suspended"&&((c=t==null?void 0:t.ctx)==null||c.resume()),t.started)return;console.log("renders");let s=[0,n.mul(0,n.meter({name:"main:sample-rate"},n.sr()))];for(let g in t.layers){let a=t.layers[g];if(a)for(let i in a.signal){let v=n.mul(n.sm(n.const({key:`${a}:volume`,value:a.mute?0:(a==null?void 0:a.volume)||1})),a.signal[i]);s[i]=n.tanh(n.add(s[i],v))}}(m=t==null?void 0:t.core)==null||m.render(s[1],n.fft({name:"main:fft",size:2048},s[0])),t.started=t.started||Date.now()}async function o(){t.initiating||t.initiated||(t.initiating=!0,t.ctx=r(new(AudioContext||webkitAudioContext)),t.core=r(new w),t.node=r(await t.core.initialize(t.ctx,{numberOfInputs:1,numberOfOutputs:1,outputChannelCount:[2]})),t.node.connect(t.ctx.destination),t.core.on("meter",e=>{f[e.source]={max:e.max,min:e.min}}),t.core.on("scope",e=>{p[e.source]=[...e==null?void 0:e.data[0].values()]}),t.core.on("fft",e=>{x[e.source]=[[...e==null?void 0:e.data.real.values()],[...e==null?void 0:e.data.imag.values()]]}),t.initiated=!0)}export{k as u};
