import{_ as Bt}from"./chunks/ControlStart.931a09c0.js";import{i as Tt,m as It}from"./chunks/audio.cd4fd50f.js";import{b as Ot}from"./chunks/calculations.65ee336d.js";import{u as Dt}from"./chunks/mic.97cb31ca.js";import{k as kt,V as Ze,D as Nt,i as Ft,j as Mt,m as Gt,o as Ie,c as Fe,a as Ee,n as qt,f as zt,d as Pt,t as Ht,_ as Xt,E as Wt,g as et,z as Vt,B as Ut}from"./chunks/framework.02c15fb1.js";import{u as $t}from"./chunks/index.ecadaa1f.js";import"./chunks/UserMedia.1ce453ef.js";import"./chunks/Subtract.690bd439.js";import"./chunks/OnePoleFilter.20a48301.js";/**!
 * audioMotion-analyzer
 * High-resolution real-time graphic audio spectrum analyzer JS module
 *
 * @version 4.2.0
 * @author  Henrique Avila Vianna <hvianna@gmail.com> <https://henriquevianna.com>
 * @license AGPL-3.0-or-later
 */const Yt="4.2.0",ve=2*Math.PI,Xe=Math.PI/2,tt=8.17579892,it="dual-combined",pe="single",me="dual-vertical",st="bar-index",at="bar-level",De="gradient",nt=60,rt="click",jt="fullscreenchange",yt="resize",Kt="#111",ot="",lt="A",ht="B",ct="C",dt="D",ft="468",ke="sans-serif",Qt="#0f0",Jt="#7f7f7f22",Zt="create",_t="fschange",ei="lores",ti=yt,We="user",ii="#000c",ut="#fff",si="#4f4",gt="#888",ai="#555",Ve="bark",Te="linear",Ae="log",Ue="mel",pt=["#a35","#c66","#e94","#ed0","#9d5","#4d8","#2cb","#0bc","#09c","#36b"],mt=[["classic",{colorStops:["red",{color:"yellow",level:.85,pos:.6},{color:"lime",level:.475}]}],["prism",{colorStops:pt}],["rainbow",{dir:"h",colorStops:["#817",...pt,"#639"]}],["orangered",{bgColor:"#3e2f29",colorStops:["OrangeRed"]}],["steelblue",{bgColor:"#222c35",colorStops:["SteelBlue"]}]],ni=["ERR_AUDIO_CONTEXT_FAIL","Could not create audio context. Web Audio API not supported?"],ri=["ERR_INVALID_AUDIO_CONTEXT","Provided audio context is not valid"],oi=["ERR_UNKNOWN_GRADIENT","Unknown gradient"],$e=["ERR_FREQUENCY_TOO_LOW","Frequency values must be >= 1"],li=["ERR_INVALID_MODE","Invalid mode"],hi=["ERR_REFLEX_OUT_OF_RANGE","Reflex ratio must be >= 0 and < 1"],ci=["ERR_INVALID_AUDIO_SOURCE","Audio source must be an instance of HTMLMediaElement or AudioNode"],di=["ERR_GRADIENT_INVALID_NAME","Gradient name must be a non-empty string"],fi=["ERR_GRADIENT_NOT_AN_OBJECT","Gradient options must be an object"],_i=["ERR_GRADIENT_MISSING_COLOR","Gradient colorStops must be a non-empty array"];class he extends Error{constructor(e,i){const[s,l]=e;super(l+(i!==void 0?`: ${i}`:"")),this.name="AudioMotionError",this.code=s}}const wt=(ne,e)=>console.warn(`${ne} is deprecated. Use ${e} instead.`),Ne=(ne,e,i="toLowerCase")=>e[Math.max(0,e.indexOf((""+ne)[i]()))],ui=(ne,e,i,s,l)=>e+(s-e)*(l-ne)/(i-ne);Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(ne){let e=this.length;for(;e-- >0;)if(ne(this[e]))return e;return-1});class gi{constructor(e,i={}){this._ready=!1,this._aux={},this._canvasGradients=[],this._destroyed=!1,this._energy={val:0,peak:0,hold:0},this._flg={},this._fps=0,this._gradients={},this._last=0,this._outNodes=[],this._ownContext=!1,this._selectedGrads=[],this._sources=[];for(const[m,w]of mt)this.registerGradient(m,w);this._container=e||document.body,this._defaultWidth=this._container.clientWidth||640,this._defaultHeight=this._container.clientHeight||270;let s;if(!(i.source&&(s=i.source.context))){if(!(s=i.audioCtx))try{s=new(window.AudioContext||window.webkitAudioContext),this._ownContext=!0}catch{throw new he(ni)}}if(!s.createGain)throw new he(ri);const l=this._analyzer=[s.createAnalyser(),s.createAnalyser()],h=this._splitter=s.createChannelSplitter(2),r=this._merger=s.createChannelMerger(2);this._input=s.createGain(),this._output=s.createGain(),i.source&&this.connectInput(i.source);for(const m of[0,1])h.connect(l[m],m);r.connect(this._output),i.connectSpeakers!==!1&&this.connectOutput();const a=document.createElement("canvas");a.style="max-width: 100%;",this._ctx=a.getContext("2d");for(const m of["_scaleX","_scaleR"])this[m]=document.createElement("canvas").getContext("2d");this._fsEl=i.fsElement||a;const f=()=>{this._fsTimeout||(this._fsTimeout=window.setTimeout(()=>{this._fsChanging||(this._setCanvas(ti),this._fsTimeout=0)},nt))};window.ResizeObserver&&(this._observer=new ResizeObserver(f),this._observer.observe(this._container)),this._controller=new AbortController;const o=this._controller.signal;window.addEventListener(yt,f,{signal:o}),a.addEventListener(jt,()=>{this._fsChanging=!0,this._fsTimeout&&window.clearTimeout(this._fsTimeout),this._setCanvas(_t),this._fsTimeout=window.setTimeout(()=>{this._fsChanging=!1,this._fsTimeout=0},nt)},{signal:o});const p=()=>{s.state=="suspended"&&s.resume(),window.removeEventListener(rt,p)};window.addEventListener(rt,p),document.addEventListener("visibilitychange",()=>{document.visibilityState!="hidden"&&(this._frames=0,this._time=performance.now())},{signal:o}),this._setProps(i,!0),this.useCanvas&&this._container.appendChild(a),this._ready=!0,this._setCanvas(Zt)}get alphaBars(){return this._alphaBars}set alphaBars(e){this._alphaBars=!!e,this._calcBars()}get ansiBands(){return this._ansiBands}set ansiBands(e){this._ansiBands=!!e,this._calcBars()}get barSpace(){return this._barSpace}set barSpace(e){this._barSpace=+e||0,this._calcBars()}get channelLayout(){return this._chLayout}set channelLayout(e){this._chLayout=Ne(e,[pe,me,it]),this._input.disconnect(),this._input.connect(this._chLayout!=pe?this._splitter:this._analyzer[0]),this._analyzer[0].disconnect(),this._outNodes.length&&this._analyzer[0].connect(this._chLayout!=pe?this._merger:this._output),this._calcBars(),this._makeGrad()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=Ne(e,[De,st,at])}get fftSize(){return this._analyzer[0].fftSize}set fftSize(e){for(const s of[0,1])this._analyzer[s].fftSize=e;const i=this._analyzer[0].frequencyBinCount;this._fftData=[new Float32Array(i),new Float32Array(i)],this._calcBars()}get frequencyScale(){return this._frequencyScale}set frequencyScale(e){this._frequencyScale=Ne(e,[Ae,Ve,Ue,Te]),this._calcBars()}get gradient(){return this._selectedGrads[0]}set gradient(e){this._setGradient(e)}get gradientLeft(){return this._selectedGrads[0]}set gradientLeft(e){this._setGradient(e,0)}get gradientRight(){return this._selectedGrads[1]}set gradientRight(e){this._setGradient(e,1)}get height(){return this._height}set height(e){this._height=e,this._setCanvas(We)}get ledBars(){return this._showLeds}set ledBars(e){this._showLeds=!!e,this._calcBars()}get linearAmplitude(){return this._linearAmplitude}set linearAmplitude(e){this._linearAmplitude=!!e}get linearBoost(){return this._linearBoost}set linearBoost(e){this._linearBoost=e>=1?+e:1}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=+e||0}get loRes(){return this._loRes}set loRes(e){this._loRes=!!e,this._setCanvas(ei)}get lumiBars(){return this._lumiBars}set lumiBars(e){this._lumiBars=!!e,this._calcBars(),this._makeGrad()}get maxDecibels(){return this._analyzer[0].maxDecibels}set maxDecibels(e){for(const i of[0,1])this._analyzer[i].maxDecibels=e}get maxFPS(){return this._maxFPS}set maxFPS(e){this._maxFPS=e<0?0:+e||0}get maxFreq(){return this._maxFreq}set maxFreq(e){if(e<1)throw new he($e);this._maxFreq=Math.min(e,this.audioCtx.sampleRate/2),this._calcBars()}get minDecibels(){return this._analyzer[0].minDecibels}set minDecibels(e){for(const i of[0,1])this._analyzer[i].minDecibels=e}get minFreq(){return this._minFreq}set minFreq(e){if(e<1)throw new he($e);this._minFreq=+e,this._calcBars()}get mirror(){return this._mirror}set mirror(e){this._mirror=Math.sign(e)|0,this._calcBars(),this._makeGrad()}get mode(){return this._mode}set mode(e){const i=e|0;if(i>=0&&i<=10&&i!=9)this._mode=i,this._calcBars(),this._makeGrad();else throw new he(li,e)}get noteLabels(){return this._noteLabels}set noteLabels(e){this._noteLabels=!!e,this._createScales()}get outlineBars(){return this._outlineBars}set outlineBars(e){this._outlineBars=!!e,this._calcBars()}get peakLine(){return this._peakLine}set peakLine(e){this._peakLine=!!e}get radial(){return this._radial}set radial(e){this._radial=!!e,this._calcBars(),this._makeGrad()}get reflexRatio(){return this._reflexRatio}set reflexRatio(e){if(e=+e||0,e<0||e>=1)throw new he(hi);this._reflexRatio=e,this._calcBars(),this._makeGrad()}get roundBars(){return this._roundBars}set roundBars(e){this._roundBars=!!e,this._calcBars()}get smoothing(){return this._analyzer[0].smoothingTimeConstant}set smoothing(e){for(const i of[0,1])this._analyzer[i].smoothingTimeConstant=e}get spinSpeed(){return this._spinSpeed}set spinSpeed(e){e=+e||0,(this._spinSpeed===void 0||e==0)&&(this._spinAngle=-Xe),this._spinSpeed=e}get splitGradient(){return this._splitGradient}set splitGradient(e){this._splitGradient=!!e,this._makeGrad()}get stereo(){return wt("stereo","channelLayout"),this._chLayout!=pe}set stereo(e){wt("stereo","channelLayout"),this.channelLayout=e?me:pe}get trueLeds(){return this._trueLeds}set trueLeds(e){this._trueLeds=!!e}get volume(){return this._output.gain.value}set volume(e){this._output.gain.value=e}get weightingFilter(){return this._weightingFilter}set weightingFilter(e){this._weightingFilter=Ne(e,[ot,lt,ht,ct,dt,ft],"toUpperCase")}get width(){return this._width}set width(e){this._width=e,this._setCanvas(We)}get audioCtx(){return this._input.context}get canvas(){return this._ctx.canvas}get canvasCtx(){return this._ctx}get connectedSources(){return this._sources}get connectedTo(){return this._outNodes}get fps(){return this._fps}get fsHeight(){return this._fsHeight}get fsWidth(){return this._fsWidth}get isAlphaBars(){return this._flg.isAlpha}get isBandsMode(){return this._flg.isBands}get isDestroyed(){return this._destroyed}get isFullscreen(){return this._fsEl&&(document.fullscreenElement||document.webkitFullscreenElement)===this._fsEl}get isLedBars(){return this._flg.isLeds}get isLumiBars(){return this._flg.isLumi}get isOctaveBands(){return this._flg.isOctaves}get isOn(){return!!this._runId}get isOutlineBars(){return this._flg.isOutline}get pixelRatio(){return this._pixelRatio}get isRoundBars(){return this._flg.isRound}static get version(){return Yt}connectInput(e){const i=e instanceof HTMLMediaElement;if(!(i||e.connect))throw new he(ci);const s=i?this.audioCtx.createMediaElementSource(e):e;return this._sources.includes(s)||(s.connect(this._input),this._sources.push(s)),s}connectOutput(e=this.audioCtx.destination){if(!this._outNodes.includes(e)&&(this._output.connect(e),this._outNodes.push(e),this._outNodes.length==1))for(const i of[0,1])this._analyzer[i].connect(this._chLayout==pe&&!i?this._output:this._merger,0,i)}destroy(){if(!this._ready)return;const{audioCtx:e,canvas:i,_controller:s,_input:l,_merger:h,_observer:r,_ownContext:a,_splitter:f}=this;this._destroyed=!0,this._ready=!1,this.stop(),s.abort(),r&&r.disconnect(),this.onCanvasResize=null,this.onCanvasDraw=null,this._fsEl=null,this.disconnectInput(),this.disconnectOutput(),l.disconnect(),f.disconnect(),h.disconnect(),a&&e.close(),i.remove(),this._calcBars()}disconnectInput(e,i){e?Array.isArray(e)||(e=[e]):e=Array.from(this._sources);for(const s of e){const l=this._sources.indexOf(s);if(i&&s.mediaStream)for(const h of s.mediaStream.getAudioTracks())h.stop();l>=0&&(s.disconnect(this._input),this._sources.splice(l,1))}}disconnectOutput(e){if(!(e&&!this._outNodes.includes(e))&&(this._output.disconnect(e),this._outNodes=e?this._outNodes.filter(i=>i!==e):[],this._outNodes.length==0))for(const i of[0,1])this._analyzer[i].disconnect()}getBars(){return Array.from(this._bars,({posX:e,freq:i,freqLo:s,freqHi:l,hold:h,peak:r,value:a})=>({posX:e,freq:i,freqLo:s,freqHi:l,hold:h,peak:r,value:a}))}getEnergy(e,i){if(e===void 0)return this._energy.val;if(e!=+e){if(e=="peak")return this._energy.peak;const a={bass:[20,250],lowMid:[250,500],mid:[500,2e3],highMid:[2e3,4e3],treble:[4e3,16e3]};if(!a[e])return null;[e,i]=a[e]}const s=this._freqToBin(e),l=i?this._freqToBin(i):s,h=this._chLayout==pe?1:2;let r=0;for(let a=0;a<h;a++)for(let f=s;f<=l;f++)r+=this._normalizedB(this._fftData[a][f]);return r/(l-s+1)/h}registerGradient(e,i){if(typeof e!="string"||e.trim().length==0)throw new he(di);if(typeof i!="object")throw new he(fi);const{colorStops:s}=i;if(!Array.isArray(s)||!s.length)throw new he(_i);const l=s.length,h=r=>+r!=r||r<0||r>1;s.forEach((r,a)=>{const f=a/Math.max(1,l-1);typeof r!="object"?s[a]={pos:f,color:r}:h(r.pos)&&(r.pos=f),h(r.level)&&(s[a].level=1-a/l)}),s.sort((r,a)=>r.level<a.level?1:r.level>a.level?-1:0),s[0].level=1,this._gradients[e]={bgColor:i.bgColor||Kt,dir:i.dir,colorStops:s},this._selectedGrads.includes(e)&&this._makeGrad()}setCanvasSize(e,i){this._width=e,this._height=i,this._setCanvas(We)}setFreqRange(e,i){if(e<1||i<1)throw new he($e);this._minFreq=Math.min(e,i),this.maxFreq=Math.max(e,i)}setLedParams(e){let i,s,l;e&&(i=e.maxLeds|0,s=+e.spaceV,l=+e.spaceH),this._ledParams=i>0&&s>0&&l>=0?[i,s,l]:void 0,this._calcBars()}setOptions(e){this._setProps(e)}setSensitivity(e,i){for(const s of[0,1])this._analyzer[s].minDecibels=Math.min(e,i),this._analyzer[s].maxDecibels=Math.max(e,i)}start(){this.toggleAnalyzer(!0)}stop(){this.toggleAnalyzer(!1)}toggleAnalyzer(e){const i=this.isOn;return e===void 0&&(e=!i),i&&!e?(cancelAnimationFrame(this._runId),this._runId=0):!i&&e&&!this._destroyed&&(this._frames=0,this._time=performance.now(),this._runId=requestAnimationFrame(s=>this._draw(s))),this.isOn}toggleFullscreen(){if(this.isFullscreen)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{const e=this._fsEl;if(!e)return;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}}_binToFreq(e){return e*this.audioCtx.sampleRate/this.fftSize||1}_calcBars(){const e=this._bars=[];if(!this._ready){this._flg={isAlpha:!1,isBands:!1,isLeds:!1,isLumi:!1,isOctaves:!1,isOutline:!1,isRound:!1,noLedGap:!1};return}const i=this._barSpace,s=this.canvas,l=s.width>>1,h=this._chLayout,r=this._ansiBands,a=this._radial,f=h==me&&!a,o=this._maxFreq,p=this._minFreq,m=this._mode,w=m%10!=0,G=w&&this._frequencyScale==Ae,_=this._showLeds&&w&&!a,g=this._lumiBars&&w&&!a,I=this._alphaBars&&!g&&m!=10,A=this._outlineBars&&w&&!g&&!_,P=this._roundBars&&w&&!g&&!_,H=h!=me||this._reflexRatio>0&&!g,U=s.height-(f&&!_?.5:0)>>f,t=U*(g||a?1:1-this._reflexRatio)|0,D=s.width-l*(this._mirror!=0),j=f?s.height-U*2:0,X=l*(this._mirror==-1&&!a),W=Math.min(s.width,s.height)*(h==me?.375:.125)|0,K=b=>e.push({...b,peak:[0,0],hold:[0],value:[0]}),ce=b=>{const C=this._freqToBin(b,"floor"),u=this._binToFreq(C),L=this._binToFreq(C+1),v=Math.log2(b/u)/Math.log2(L/u);return[C,v]};let V,y,R;if(G){const b=(E,F,ee)=>+E.toPrecision(ee?Math.max(F,1+Math.log10(E)|0):F),C=E=>{const F=[1,1.12,1.25,1.4,1.6,1.8,2,2.24,2.5,2.8,3.15,3.55,4,4.5,5,5.6,6.3,7.1,8,9,10],ee=Math.log10(E)|0,we=E/10**ee;let te=1;for(;te<F.length&&we>F[te];)te++;return we-F[te-1]<F[te]-we&&te--,(F[te]*10**(ee+5)|0)/1e5},u=[0,24,12,8,6,4,3,2,1][this._mode],L=r?10**(3/(u*10)):2**(1/u),v=L**.5;let N=r?7.94328235/(u%2?1:v):tt;do{let E=N;const F=b(E/v,4,!0),ee=b(E*v,4,!0),[we,te]=ce(F),[Se,ue]=ce(ee);r?E=u<4?C(E):b(E,E.toString()[0]<5?3:2):E=b(E,4,!0),E>=p&&K({posX:0,freq:E,freqLo:F,freqHi:ee,binLo:we,binHi:Se,ratioLo:te,ratioHi:ue}),N*=L}while(N<=o);V=D/e.length,e.forEach((E,F)=>E.posX=X+F*V);const B=e[0],$=e[e.length-1];y=this._freqScaling(B.freqLo),R=D/(this._freqScaling($.freqHi)-y),B.freqLo<p&&(B.freqLo=p,[B.binLo,B.ratioLo]=ce(p)),$.freqHi>o&&($.freqHi=o,[$.binHi,$.ratioHi]=ce(o))}else if(w){const b=[0,24,12,8,6,4,3,2,1][this._mode]*10,C=u=>{switch(this._frequencyScale){case Ve:return 1960/(26.81/(u+.53)-1);case Ue:return 700*(2**u-1);case Te:return u}};V=D/b,y=this._freqScaling(p),R=D/(this._freqScaling(o)-y);for(let u=0,L=0;u<b;u++,L+=V){const v=C(y+L/R),N=C(y+(L+V/2)/R),B=C(y+(L+V)/R),[$,E]=ce(v),[F,ee]=ce(B);K({posX:X+L,freq:N,freqLo:v,freqHi:B,binLo:$,binHi:F,ratioLo:E,ratioHi:ee})}}else{V=1,y=this._freqScaling(p),R=D/(this._freqScaling(o)-y);const b=this._freqToBin(p,"floor"),C=this._freqToBin(o);let u=-999;for(let L=b;L<=C;L++){const v=this._binToFreq(L),N=X+Math.round(R*(this._freqScaling(v)-y));if(N>u)K({posX:N,freq:v,freqLo:v,freqHi:v,binLo:L,binHi:L,ratioLo:0,ratioHi:0}),u=N;else if(e.length){const B=e[e.length-1];B.binHi=L,B.freqHi=v,B.freq=(B.freqLo*v)**.5}}}let O=0,d=0;if(_){const b=this._pixelRatio/(window.devicePixelRatio>1&&window.screen.height<=540?2:1),C=[[],[128,3,.45],[128,4,.225],[96,6,.225],[80,6,.225],[80,6,.125],[64,6,.125],[48,8,.125],[24,16,.125]],u=this._ledParams,[L,v,N]=u||C[m];let B,$=t;if(u){const E=2*b;let F;B=L+1;do B--,F=$/B/(1+v),d=F*v;while((F<E||d<E)&&B>1)}else{const E=540/v;d=Math.min(v*b,Math.max(2,$/E+.1|0))}H&&($+=d),u||(B=Math.min(L,$/(d*2)|0)),O=N>=1?N:V*N,this._leds=[B,O,d,$/B-d]}const J=Math.min(V-1,i*(i>0&&i<1?V:1));w&&(V-=Math.max(_?O:0,J)),e.forEach((b,C)=>{let u=b.posX,L=V;w&&(i==0&&!_?(u|=0,L|=0,C>0&&u>e[C-1].posX+e[C-1].width&&(u--,L++)):u+=Math.max(_?O:0,J)/2,b.posX=u),b.barCenter=u+(V==1?0:L/2),b.width=L});const de=[];for(const b of[0,1]){const C=h==me?(U+j)*b:0,u=C+U,L=C+t-(!_||H?0:d);de.push({channelTop:C,channelBottom:u,analyzerBottom:L})}this._aux={analyzerHeight:t,analyzerWidth:D,channelCoords:de,channelHeight:U,channelGap:j,initialX:X,radius:W,scaleMin:y,unitWidth:R},this._flg={isAlpha:I,isBands:w,isLeds:_,isLumi:g,isOctaves:G,isOutline:A,isRound:P,noLedGap:H},this._createScales()}_createScales(){if(!this._ready)return;const{analyzerWidth:e,initialX:i,radius:s,scaleMin:l,unitWidth:h}=this._aux,{canvas:r,_frequencyScale:a,_mirror:f,_noteLabels:o,_radial:p,_scaleX:m,_scaleR:w}=this,G=m.canvas,_=w.canvas,g=[],I=this._chLayout==me,A=["C",,"D",,"E","F",,"G",,"A",,"B"],P=Math.min(r.width,r.height)/34|0,H=G.height>>1,U=P>>1,t=H*(o?.7:1.5),D=U*(o?1:2),j=2**(1/12);if(!o&&(this._ansiBands||a!=Ae))g.push(16,31.5,63,125,250,500,1e3,2e3,4e3),a==Te?g.push(6e3,8e3,1e4,12e3,14e3,16e3,18e3,2e4,22e3):g.push(8e3,16e3);else{let y=tt;for(let R=-1;R<11;R++)for(let O=0;O<12;O++){if(y>=this._minFreq&&y<=this._maxFreq){const d=A[O],J=d=="C";(d&&o&&!f||J)&&g.push(o?[y,d+(J?R:"")]:y)}y*=j}}_.width=_.height=(s<<1)+I*P;const X=_.width>>1,W=X-P*.7,K=(y,R)=>{const O=ve*(y/r.width),d=O-Xe,J=W*Math.cos(d),de=W*Math.sin(d);w.save(),w.translate(X+J,X+de),w.rotate(O),w.fillText(R,0,0),w.restore()};G.width|=0,m.fillStyle=w.strokeStyle=ii,m.fillRect(0,0,G.width,G.height),w.arc(X,X,X-P/2,0,ve),w.lineWidth=P,w.stroke(),m.fillStyle=w.fillStyle=ut,m.font=`${H}px ${ke}`,w.font=`${U}px ${ke}`,m.textAlign=w.textAlign="center";let ce=-t/4,V=-D;for(const y of g){const[R,O]=Array.isArray(y)?y:[y,y<1e3?y|0:`${(y/100|0)/10}k`],d=h*(this._freqScaling(R)-l),J=G.height*.75,de=O[0]=="C",b=H*(o&&!f?de?1.2:.6:3);if(m.fillStyle=w.fillStyle=de&&!f?si:ut,o){const C=a==Ae,u=a==Te;let L=["C"];if((C||R>2e3||!u&&R>250||(!p||I)&&(!u&&R>125||R>1e3))&&L.push("G"),(C||R>4e3||!u&&R>500||(!p||I)&&(!u&&R>250||R>2e3))&&L.push("E"),(u&&R>4e3||(!p||I)&&(C||R>2e3||!u&&R>500))&&L.push("D","F","A","B"),!L.includes(O[0]))continue}d>=ce+t/2&&d<=e&&(m.fillText(O,i+d,J,b),f&&(d>t||f==1)&&m.fillText(O,(i||r.width)-d,J,b),ce=d+Math.min(b,m.measureText(O).width)/2),d>=V+D&&d<e-D&&(K(d,O),f&&(d>D||f==1)&&K(-d,O),V=d)}}_draw(e){if(this._runId=requestAnimationFrame(n=>this._draw(n)),this._maxFPS&&e-this._last<1e3/this._maxFPS)return;const{isAlpha:i,isBands:s,isLeds:l,isLumi:h,isOctaves:r,isOutline:a,isRound:f,noLedGap:o}=this._flg,{analyzerHeight:p,channelCoords:m,channelHeight:w,channelGap:G,initialX:_,radius:g}=this._aux,{_bars:I,canvas:A,_canvasGradients:P,_chLayout:H,_colorMode:U,_ctx:t,_energy:D,fillAlpha:j,_fps:X,_linearAmplitude:W,_lineWidth:K,maxDecibels:ce,minDecibels:V,_mirror:y,_mode:R,overlay:O,_radial:d,showBgColor:J,showPeaks:de,useCanvas:b,_weightingFilter:C}=this,u=this._scaleX.canvas,L=this._scaleR.canvas,v=A.width>>1,N=A.height>>1,B=X>>1,$=H==me,E=H==it,F=H==pe,ee=l&&this._trueLeds&&U==De,we=d?A.width:this._aux.analyzerWidth,te=_+we,Se=de&&this._peakLine&&R==10,ue=d?Math.min(v,N)-g:p,[Lt,Ci,Ce,Me]=this._leds||[];D.val>0&&(this._spinAngle+=this._spinSpeed*ve/(60*X));const Rt=n=>{if(this._reflexRatio>0&&!h){let c,q;this.reflexFit||$?(c=$&&n==0?w+G:0,q=w-p):(c=A.height-p*2,q=p),t.save(),t.globalAlpha=this.reflexAlpha,this.reflexBright!=1&&(t.filter=`brightness(${this.reflexBright})`),t.setTransform(1,0,0,-1,0,A.height),t.drawImage(A,0,m[n].channelTop,A.width,p,0,c,A.width,q),t.restore()}},bt=()=>{this.showScaleX&&(d?(t.save(),t.translate(v,N),this._spinSpeed&&t.rotate(this._spinAngle+Xe),t.drawImage(L,-L.width>>1,-L.width>>1),t.restore()):t.drawImage(u,0,A.height-u.height))},St=n=>{const c=u.height,q=c>>1,T=W?100:ce,ie=W?0:V,z=W?20:5,Z=p/(T-ie);t.save(),t.fillStyle=gt,t.font=`${q}px ${ke}`,t.textAlign="right",t.lineWidth=1;for(let Y=T;Y>ie;Y-=z){const fe=n+(T-Y)*Z,_e=Y%2==0|0;if(_e){const Le=fe+q*(fe==n?.8:.35);y!=-1&&t.fillText(Y,c*.85,Le),y!=1&&t.fillText(Y,A.width-c*.1,Le),t.strokeStyle=gt,t.setLineDash([2,4]),t.lineDashOffset=0}else t.strokeStyle=ai,t.setLineDash([2,8]),t.lineDashOffset=1;t.beginPath(),t.moveTo(_+c*_e*(y!=-1),~~fe+.5),t.lineTo(te-c*_e*(y!=1),~~fe+.5),t.stroke()}t.restore()},xt=n=>{const c=n**2,q=424.36,T=11599.29,ie=25122.25,z=544496.41,Z=148693636,Y=fe=>20*Math.log10(fe);switch(C){case lt:const fe=Z*c**2/((c+q)*Math.sqrt((c+T)*(c+z))*(c+Z));return 2+Y(fe);case ht:const _e=Z*c*n/((c+q)*Math.sqrt(c+ie)*(c+Z));return .17+Y(_e);case ct:const Le=Z*c/((c+q)*(c+Z));return .06+Y(Le);case dt:const Be=((103791848e-2-c)**2+108076816e-2*c)/((9837328-c)**2+11723776*c),se=n/68966888496476e-18*Math.sqrt(Be/((c+79919.29)*(c+1345600)));return Y(se);case ft:const Re=-4737338981378384e-39*n**6+2043828333606125e-30*n**4-1363894795463638e-22*c+1,x=1306612257412824e-34*n**5-2118150887518656e-26*n**3+.0005559488023498642*n,k=.0001246332637532143*n/Math.hypot(Re,x);return 18.2+Y(k)}return 0},Ge=(n,c,q)=>{t.beginPath(),t.moveTo(n,c),t.lineTo(n,q),t.stroke()},qe=n=>{if(n&&K){const c=t.globalAlpha;t.globalAlpha=1,t.stroke(),t.globalAlpha=c}},ze=(n,c)=>c*ve*(n/A.width)+this._spinAngle,ge=(n,c,q=1)=>{const T=g+c,ie=ze(n,q);return[v+T*Math.cos(ie),N+T*Math.sin(ie)]},Pe=(n,c,q,T,ie)=>{t.beginPath();for(const z of y?[1,-1]:[1]){const[Z,Y]=f?[ze(n,z),ze(n+q,z)]:[];t.moveTo(...ge(n,c,z)),t.lineTo(...ge(n,c+T,z)),f?t.arc(v,N,g+c+T,Z,Y,z!=1):t.lineTo(...ge(n+q,c+T,z)),t.lineTo(...ge(n+q,c,z)),f&&!ie&&t.arc(v,N,g+c,Y,Z,z==1)}qe(ie),t.fill()},ye=n=>Math.max(0,(n*Lt|0)*(Me+Ce)-Ce),vt=n=>{D.val=n,D.peak>0&&(D.hold--,D.hold<0&&(D.peak+=D.hold/(B*B/2))),n>=D.peak&&(D.peak=n,D.hold=B)},At=()=>{const n=e-this._time;if(this._last=e-(this._maxFPS?n%(1e3/this._maxFPS):0),this._frames++,n>=1e3&&(this._fps=this._frames/(n/1e3),this._frames=0,this._time=e),this.showFPS){const c=u.height;t.font=`bold ${c}px ${ke}`,t.fillStyle=Qt,t.textAlign="right",t.fillText(Math.round(this._fps),A.width-c,c*2)}};let Ye=0;const je=I.length,Ke=F?1:2;for(let n=0;n<Ke;n++){const{channelTop:c,channelBottom:q,analyzerBottom:T}=m[n],ie=this._gradients[this._selectedGrads[n]],z=ie.colorStops,Z=z.length,Y=!J||l&&!O?"#000":ie.bgColor,fe=n==0||!d&&!E,_e=n&&d&&$?-1:1,Le=(x,k)=>{const S=se[x]+(x<se.length-1?(se[x+1]-se[x])*k:0);return isNaN(S)?-1/0:S},Be=(x=0,k=0)=>{let S;if(U==De&&!ee||R==10)S=P[n];else{const Q=U==st?k%Z:z.findLastIndex(re=>l?ye(x)<=ye(re.level):x<=re.level);S=z[Q].color}t.fillStyle=t.strokeStyle=S};if(b&&(O&&fe&&t.clearRect(0,c-G,A.width,w+G),(!O||J)&&(O&&(t.globalAlpha=this.bgAlpha),t.fillStyle=Y,fe&&t.fillRect(_,c-G,we,(O&&this.reflexAlpha==1?p:w)+G),t.globalAlpha=1),this.showScaleY&&!h&&!d&&(n==0||!E)&&St(c),l?(t.setLineDash([Me,Ce]),t.lineWidth=I[0].width):t.lineWidth=a?Math.min(K,I[0].width/2):K,t.save(),!d)){const x=new Path2D;x.rect(0,c,A.width,p),t.clip(x)}let se=this._fftData[n];this._analyzer[n].getFloatFrequencyData(se),C&&(se=se.map((x,k)=>x+xt(this._binToFreq(k)))),t.beginPath();let Re=[];for(let x=0;x<je;x++){const k=I[x],{posX:S,barCenter:Q,width:re,freq:He,binLo:Oe,binHi:Qe,ratioLo:Et,ratioHi:Ct}=k;let ae=Math.max(Le(Oe,Et),Le(Qe,Ct));for(let M=Oe+1;M<Qe;M++)se[M]>ae&&(ae=se[M]);if(ae=this._normalizedB(ae),k.value[n]=ae,Ye+=ae,k.peak[n]>0&&(k.hold[n]--,k.hold[n]<0&&(k.peak[n]+=k.hold[n]/(B*B/2))),ae>=k.peak[n]&&(k.peak[n]=ae,k.hold[n]=B),!b)continue;h||i?t.globalAlpha=ae:a&&(t.globalAlpha=j),Be(ae,x);const oe=(h?ue:l?ye(ae):ae*ue|0)*_e;if(R==10){const M=x?0:(this._normalizedB(se[I[1].binLo])*ue*_e+oe)/2;if(d){if(x==0&&t.lineTo(...ge(0,S<0?M:oe)),S>=0){const le=[S,oe];t.lineTo(...ge(...le)),Re.push(le)}}else{if(x==0)if(y!=-1){const le=Oe?this._normalizedB(se[Oe-1])*ue:oe;t.moveTo(_-K,T-le)}else t.moveTo(_,T-(S<_?M:oe));(y!=-1||S>=_)&&t.lineTo(S,T-oe)}}else if(l){if(J&&!O&&(n==0||!E)){const M=t.globalAlpha;t.strokeStyle=Jt,t.globalAlpha=1,Ge(Q,c,T),t.strokeStyle=t.fillStyle,t.globalAlpha=M}if(ee){const M=h?0:z.findLastIndex(be=>ye(ae)<=ye(be.level));let le=T;for(let be=Z-1;be>=M;be--){t.strokeStyle=z[be].color;let Je=T-(be==M?oe:ye(z[be].level));Ge(Q,le,Je),le=Je-Ce}}else Ge(Q,T,T-oe)}else if(S>=_)if(d)Pe(S,0,re,oe,a);else if(f){const M=re/2,le=T+M;t.beginPath(),t.moveTo(S,le),t.lineTo(S,le-oe),t.arc(Q,le-oe,M,Math.PI,ve),t.lineTo(S+re,le),qe(a),t.fill()}else{const M=a?t.lineWidth:0;t.beginPath(),t.rect(S,T+M,re,-oe-M),qe(a),t.fill()}const xe=k.peak[n];if(xe>0&&de&&!Se&&!h&&S>=_&&S<te)if(a&&K>0?t.globalAlpha=1:i&&(t.globalAlpha=xe),(U==at||ee)&&Be(xe),l){const M=ye(xe);M>=Ce&&t.fillRect(S,T-M,re,Me)}else d?R!=10&&Pe(S,xe*ue*_e,re,-2):t.fillRect(S,T-xe*ue,re,2)}if(b){if(t.restore(),t.globalAlpha=1,R==10){if(Be(),d){if(y){let x;for(;x=Re.pop();)t.lineTo(...ge(...x,-1))}t.closePath()}if(K>0&&t.stroke(),j>0&&(d?(t.moveTo(v+g,N),t.arc(v,N,g,0,ve,!0)):(t.lineTo(te,T),t.lineTo(_,T)),t.globalAlpha=j,t.fill(),t.globalAlpha=1),(Se||d&&de)&&(Re=[],t.beginPath(),I.forEach((x,k)=>{let S=x.posX,Q=x.peak[n],re=k?"lineTo":"moveTo";if(d&&S<0){const He=I[k+1];Q=ui(S,Q,He.posX,He.peak[n],0),S=0}Q*=ue*_e,Se?(t[re](...d?ge(S,Q):[S,T-Q]),d&&y&&Re.push([S,Q])):Q&&Pe(S,Q,1,-2*_e)}),Se)){let x;for(;x=Re.pop();)t.lineTo(...ge(...x,-1));t.lineWidth=1,t.stroke()}}Rt(n)}}vt(Ye/(je<<Ke-1)),b&&(y&&!d&&(t.setTransform(-1,0,0,1,A.width-_,0),t.drawImage(A,_,0,v,A.height,0,0,v,A.height),t.setTransform(1,0,0,1,0,0)),t.setLineDash([]),bt()),At(),this.onCanvasDraw&&(t.save(),t.fillStyle=t.strokeStyle=P[0],this.onCanvasDraw(this,{timestamp:e,_canvasGradients:P}),t.restore())}_freqScaling(e){switch(this._frequencyScale){case Ae:return Math.log2(e);case Ve:return 26.81*e/(1960+e)-.53;case Ue:return Math.log2(1+e/700);case Te:return e}}_freqToBin(e,i="round"){const s=this._analyzer[0].frequencyBinCount-1,l=Math[i](e*this.fftSize/this.audioCtx.sampleRate);return l<s?l:s}_makeGrad(){if(!this._ready)return;const{canvas:e,_ctx:i,_radial:s,_reflexRatio:l}=this,{analyzerWidth:h,initialX:r,radius:a}=this._aux,{isLumi:f}=this._flg,o=this._chLayout==me,p=1-l,m=e.width>>1,w=e.height>>1,G=Math.min(m,w),_=f?e.height:e.height*(1-l*!o)|0;for(const g of[0,1]){const I=this._gradients[this._selectedGrads[g]],A=I.colorStops,P=I.dir=="h";let H;if(s?H=i.createRadialGradient(m,w,G,m,w,a-(G-a)*o):H=i.createLinearGradient(...P?[r,0,r+h,0]:[0,0,0,_]),A){const U=o&&!this._splitGradient&&(!P||s);for(let t=0;t<1+U;t++){const D=A.length-1;A.forEach((j,X)=>{let W=j.pos;if(U&&(W/=2),o&&!f&&!s&&!P&&(W*=p,!U&&W>.5*p&&(W+=.5*l)),t==1)if(s||f){const K=D-X;j=A[K],W=1-j.pos/2}else X==0&&W>0&&H.addColorStop(.5,j.color),W+=.5;H.addColorStop(W,j.color),o&&X==D&&W<.5&&H.addColorStop(.5,j.color)})}}this._canvasGradients[g]=H}}_normalizedB(e){const i=this._linearAmplitude,s=i?1/this._linearBoost:1,l=(f,o,p)=>f<=o?o:f>=p?p:f,h=f=>10**(f/20);let r=this.maxDecibels,a=this.minDecibels;return i&&(r=h(r),a=h(a),e=h(e)**s),l((e-a)/(r-a)**s,0,1)}_setCanvas(e){if(!this._ready)return;const{canvas:i,_ctx:s}=this,l=this._scaleX.canvas,h=window.devicePixelRatio/(this._loRes+1);let r=window.screen.width*h,a=window.screen.height*h;Math.abs(window.orientation)==90&&r<a&&([r,a]=[a,r]);const f=this.isFullscreen,o=f&&this._fsEl==i,p=o?r:(this._width||this._container.clientWidth||this._defaultWidth)*h|0,m=o?a:(this._height||this._container.clientHeight||this._defaultHeight)*h|0;this._pixelRatio=h,this._fsWidth=r,this._fsHeight=a,!(i.width==p&&i.height==m)&&(i.width=p,i.height=m,this.overlay||(s.fillStyle="#000",s.fillRect(0,0,p,m)),s.lineJoin="bevel",l.width=p,l.height=Math.max(20*h,Math.min(p,m)/32|0),this._calcBars(),this._makeGrad(),this._fsStatus!==void 0&&this._fsStatus!==f&&(e=_t),this._fsStatus=f,this.onCanvasResize&&this.onCanvasResize(e,this))}_setGradient(e,i){if(!this._gradients.hasOwnProperty(e))throw new he(oi,e);[0,1].includes(i)||(this._selectedGrads[1]=e,i=0),this._selectedGrads[i]=e,this._makeGrad()}_setProps(e,i){const s={alphaBars:!1,ansiBands:!1,barSpace:.1,bgAlpha:.7,channelLayout:pe,colorMode:De,fftSize:8192,fillAlpha:1,frequencyScale:Ae,gradient:mt[0][0],ledBars:!1,linearAmplitude:!1,linearBoost:1,lineWidth:0,loRes:!1,lumiBars:!1,maxDecibels:-25,maxFPS:0,maxFreq:22e3,minDecibels:-85,minFreq:20,mirror:0,mode:0,noteLabels:!1,outlineBars:!1,overlay:!1,peakLine:!1,radial:!1,reflexAlpha:.15,reflexBright:1,reflexFit:!0,reflexRatio:0,roundBars:!1,showBgColor:!0,showFPS:!1,showPeaks:!0,showScaleX:!0,showScaleY:!1,smoothing:.5,spinSpeed:0,splitGradient:!1,start:!0,trueLeds:!1,useCanvas:!0,volume:1,weightingFilter:ot},l=["onCanvasDraw","onCanvasResize"],h=["gradientLeft","gradientRight","height","width","stereo"],r=Object.keys(s).filter(a=>a!="start").concat(l,h);(i||e===void 0)&&(e={...s,...e});for(const a of Object.keys(e))l.includes(a)&&typeof e[a]!="function"?this[a]=void 0:r.includes(a)&&(this[a]=e[a]);e.start!==void 0&&this.toggleAnalyzer(e.start)}}const pi={class:"flex flex-col justify-center text-white"},mi={class:"fullscreen-container rounded-3xl overflow-hidden m-4",id:"screen"},wi=["width","height"],yi={class:"absolute top-4 left-4 text-xl select-none"},Li={key:0,class:"i-la-play"},Ri={key:1,class:"i-la-pause"},bi=Ee("div",{class:"i-la-trash-alt"},null,-1),Si=[bi],xi={__name:"PitchSpectrogram",setup(ne){const{mic:e,input:i}=Dt(),s=kt(!1);Ze(" ",_=>{s.value=!s.value,_.preventDefault()}),Ze("Enter",_=>{f(),_.preventDefault()});let l,h,r,a;function f(){h.fillStyle="#000",h.fillRect(0,0,o.width,o.height)}const o=Nt({initiated:!1,width:800,height:240,speed:Ft(()=>Math.floor(o.speedCount/100)),speedCount:$t(100,100,300)});function p(_){_.tap&&(s.value=!s.value),o.speedCount-=_.delta[0]/2}Mt(()=>{Tt(),l=document.getElementById("spectrogram"),h=l.getContext("2d"),r=document.createElement("canvas"),a=r.getContext("2d"),r.width=o.width,r.height=o.height,h.fillStyle="#000",h.fillRect(0,0,o.width,o.height)});let m;function w(){navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(()=>{o.initiated=!0,m=new gi(null,{mode:1,connectSpeakers:!1,volume:0,useCanvas:!1,source:It.meter,onCanvasDraw(_){if(s.value)return;a.drawImage(l,0,0,o.width,o.height);let g=_.getBars();for(let I=0;I<g.length;I++)h.fillStyle=G((g[I].freqLo+g[I].freqHi)/2,g[I].value[0]),h.fillRect(o.width-o.speed,o.height-I*(o.height/g.length),o.speed,1);h.translate(-o.speed,0),h.drawImage(r,0,0,o.width,o.height),h.setTransform(1,0,0,1,0,0)}}),e.open=!0,m.connectInput(i)}).catch(_=>{console.log("mic denied",_)})}function G(_,g){return`hsl(${Ot(_)*30}, ${g*100}%, ${g*80}%)`}return(_,g)=>{const I=Bt,A=Gt("drag");return Ie(),Fe("div",pi,[Ee("div",mi,[qt(Ee("canvas",{class:"h-full min-h-30em w-full rounded-md cursor-pointer",id:"spectrogram",width:o.width,height:o.height},null,8,wi),[[A,p]]),o.initiated?Pt("",!0):(Ie(),zt(I,{key:0,class:"absolute",onClick:g[0]||(g[0]=P=>w())})),Ee("div",yi,"x"+Ht(o.speed),1),Ee("button",{class:"absolute bottom-4 left-4 text-xl select-none cursor-pointer",onMousedown:g[1]||(g[1]=P=>s.value=!s.value)},[s.value?(Ie(),Fe("div",Li)):(Ie(),Fe("div",Ri))],32),Ee("button",{class:"absolute top-4 right-4 text-xl select-none cursor-pointer",onMousedown:g[2]||(g[2]=P=>f())},Si,32)])])}}},Gi=JSON.parse('{"title":"Spectrogram","description":"2.5D representation on frequency domain in time","frontmatter":{"title":"Spectrogram","description":"2.5D representation on frequency domain in time","date":"2022-06-16T00:00:00.000Z","cover":"spectrogram.png","usefulLinks":["https://codepen.io/hvianna/pen/ZEKWWJb","https://www.npmjs.com/package/audiomotion-analyzer","https://github.com/ListeningToWaves/SpectrogramTesting/blob/master/src/components/spectrogram.js"]},"headers":[],"relativePath":"practice/pitch/spectrogram/index.md","filePath":"practice/pitch/spectrogram/index.md","lastUpdated":1693938056000}'),vi={name:"practice/pitch/spectrogram/index.md"},Ai=Ut("",3);function Ei(ne,e,i,s,l,h){const r=xi,a=Wt("client-only");return Ie(),Fe("div",null,[et(a,null,{default:Vt(()=>[et(r,{class:"mb-8"})]),_:1}),Ai])}const qi=Xt(vi,[["render",Ei]]);export{Gi as __pageData,qi as default};
